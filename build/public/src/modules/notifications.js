"use strict";define("notifications",["sounds","translator","components"],function(t,a,i){var n={};var e={};n.prepareDOM=function(){var a=i.get("notifications");var o=a.children("a");var r=i.get("notifications/list");o.on("click",function(t){t.preventDefault();if(a.hasClass("open")){return}n.loadNotifications(r)});r.on("click","[data-nid]",function(){var t=$(this).hasClass("unread");if(!t){return}var a=$(this).attr("data-nid");socket.emit("notifications.markRead",a,function(t){if(t){return app.alertError(t.message)}if(e[a]){delete e[a]}})});a.on("click",".mark-all-read",n.markAllRead);r.on("click",".mark-read",function(){var t=$(this).parent();var a=t.hasClass("unread");var i=t.attr("data-nid");socket.emit("notifications.mark"+(a?"Read":"Unread"),i,function(n){if(n){return app.alertError(n.message)}t.toggleClass("unread");if(a&&e[i]){delete e[i]}});return false});socket.on("event:new_notification",function(a){var i={alert_id:"new_notif",title:"[[notifications:new_notification]]",timeout:2e3};if(a.path){i.message=a.bodyShort;i.type="info";i.clickfn=function(){if(a.path.startsWith("http")&&a.path.startsWith("https")){window.location.href=a.path}else{window.location.href=window.location.protocol+"//"+window.location.host+config.relative_path+a.path}}}else{i.message="[[notifications:you_have_unread_notifications]]";i.type="warning"}app.alert(i);app.refreshTitle();if(ajaxify.currentPage==="notifications"){ajaxify.refresh()}socket.emit("notifications.getCount",function(t,a){if(t){return app.alertError(t.message)}n.updateNotifCount(a)});if(!e[a.nid]){t.play("notification",a.nid);e[a.nid]=true}});socket.on("event:notifications.updateCount",function(t){n.updateNotifCount(t)})};n.loadNotifications=function(t){socket.emit("notifications.get",null,function(i,n){if(i){return app.alertError(i.message)}var e=n.unread.concat(n.read).sort(function(t,a){return parseInt(t.datetime,10)>parseInt(a.datetime,10)?-1:1});a.toggleTimeagoShorthand();for(var o=0;o<e.length;o+=1){e[o].timeago=$.timeago(new Date(parseInt(e[o].datetime,10)))}a.toggleTimeagoShorthand();templates.parse("partials/notifications_list",{notifications:e},function(a){t.translateHtml(a)})})};n.updateNotifCount=function(t){var a=i.get("notifications/icon");t=Math.max(0,t);if(t>0){a.removeClass("fa-bell-o").addClass("fa-bell")}else{a.removeClass("fa-bell").addClass("fa-bell-o")}a.toggleClass("unread-count",t>0);a.attr("data-content",t>99?"99+":t);var n={count:t,updateFavicon:true};$(window).trigger("action:notification.updateCount",n);if(n.updateFavicon){Tinycon.setBubble(t>99?"99+":t)}};n.markAllRead=function(){socket.emit("notifications.markAllRead",function(t){if(t){app.alertError(t.message)}e={}})};return n});
//# sourceMappingURL=public/src/modules/notifications.js.map