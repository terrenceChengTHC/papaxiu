"use strict";define("composer",["taskbar","translator","composer/controls","composer/uploads","composer/formatting","composer/drafts","composer/tags","composer/categoryList","composer/preview","composer/resize","composer/autocomplete","scrollStop"],function(e,t,i,o,n,a,s,r,d,c,l,p){var f={active:undefined,posts:{},bsEnvironment:undefined,formatting:undefined};$(window).off("resize",u).on("resize",u);u();$(window).on("action:composer.topics.post",function(e,t){localStorage.removeItem("category:"+t.data.cid+":bookmark");localStorage.removeItem("category:"+t.data.cid+":bookmark:clicked")});$(window).on("popstate",function(){var e=f.bsEnvironment;if(f.active&&(e==="xs"||e==="sm")){if(!f.posts[f.active].modified){k(f.active);return}t.translate("[[modules:composer.discard]]",function(e){bootbox.confirm(e,function(e){if(e){k(f.active)}})})}});function m(){var e=f.bsEnvironment;if(ajaxify.data.template.compose===true||e==="xs"||e==="sm"){history.back()}}function u(){var e=utils.findBootstrapEnvironment();if(f.active!==undefined){c.reposition($("#cmp-uuid-"+f.active));if((e==="md"||e==="lg")&&window.location.pathname.startsWith("/compose")){history.back()}else if((e==="xs"||e==="sm")&&!window.location.pathname.startsWith("/compose")){w()}}f.bsEnvironment=e}function g(e){var t,i;if(e.hasOwnProperty("cid")){t="cid"}else if(e.hasOwnProperty("tid")){t="tid"}else if(e.hasOwnProperty("pid")){t="pid"}i=e[t];for(var o in f.posts){if(f.posts[o].hasOwnProperty(t)&&i===f.posts[o][t]){return o}}return false}function v(i){var o=utils.generateUUID(),n=g(i);if(n){e.updateActive(n);return f.load(n)}t.translate("[[topic:composer.new_topic]]",function(t){e.push("composer",o,{title:i.title?i.title:t})});if(0!==parseInt(app.user.uid,10)){if(i.hasOwnProperty("cid")){i.save_id=["composer",app.user.uid,"cid",i.cid].join(":")}else if(i.hasOwnProperty("tid")){i.save_id=["composer",app.user.uid,"tid",i.tid].join(":")}else if(i.hasOwnProperty("pid")){i.save_id=["composer",app.user.uid,"pid",i.pid].join(":")}}f.posts[o]=i;f.load(o)}function h(e,t){$("#cmp-uuid-"+e).find(".composer-submit").removeAttr("disabled");app.alert({type:"danger",timeout:3e3,title:"",message:t,alert_id:"post_error"})}f.findByTid=function(e){for(var t in f.posts){if(f.posts.hasOwnProperty(t)&&f.posts[t].hasOwnProperty("tid")&&parseInt(f.posts[t].tid,10)===parseInt(e,10)){return t}}return null};f.addButton=function(e,t,i){n.addButton(e,t,i)};f.newTopic=function(e){v({action:"topics.post",cid:e.cid,title:e.title||"",body:e.body||"",tags:e.tags||[],modified:false,isMain:true})};f.addQuote=function(e,i,o,n,a,s,r){r=r||f.active;var c=(n||"").replace(/([\\`*_{}\[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");if(s){s="> "+s.replace(/\n/g,"\n> ")+"\n\n"}var l="["+c+"]("+config.relative_path+"/post/"+(o||i)+")";if(r===undefined){if(n&&(o||i)){f.newReply(e,i,n,"[[modules:composer.user_said_in, "+a+", "+l+"]]\n"+s)}else{f.newReply(e,i,n,"[[modules:composer.user_said, "+a+"]]\n"+s)}return}else if(r!==f.active){f.load(r)}var p=$("#cmp-uuid-"+r);var m=p.find("textarea");var u=m.val();if(n&&(o||i)){t.translate("[[modules:composer.user_said_in, "+a+", "+l+"]]\n",config.defaultLang,g)}else{t.translate("[[modules:composer.user_said, "+a+"]]\n",config.defaultLang,g)}function g(e){f.posts[r].body=(u.length?u+"\n\n":"")+e+s;m.val(f.posts[r].body);P(p);d.render(p)}};f.newReply=function(e,i,o,n){t.translate(n,config.defaultLang,function(t){v({action:"posts.reply",tid:e,toPid:i,title:o,body:t,modified:false,isMain:false})})};f.editPost=function(e){socket.emit("plugins.composer.push",e,function(t,i){if(t){return app.alertError(t.message)}v({action:"posts.edit",pid:e,uid:i.uid,handle:i.handle,title:i.title,body:i.body,modified:false,isMain:i.isMain,thumb:i.thumb,tags:i.tags})})};f.load=function(e){var t=$("#cmp-uuid-"+e);if(t.length){T(e);c.reposition(t);P(t);E()}else{if(f.formatting){b(e)}else{socket.emit("plugins.composer.getFormattingOptions",function(t,i){f.formatting=i;b(e)})}}};f.enhance=function(e,i,s){if(!i&&!s){i=utils.generateUUID();f.posts[i]=s=ajaxify.data;e.attr("id","cmp-uuid-"+i)}var c=e.find("textarea");var p=a.getDraft(s.save_id);var u=e.find(".composer-submit");r.init(e,f.posts[i]);n.addHandler(e);n.addComposerButtons();d.handleToggler(e);e.find(".img-upload-btn").removeClass("hide");e.find("#files.lt-ie9").removeClass("hide");if(config.allowFileUploads){e.find(".file-upload-btn").removeClass("hide");e.find("#files.lt-ie9").removeClass("hide")}o.initialize(i,ajaxify.data.cid);if(config.allowTopicsThumbnail&&s.isMain){o.toggleThumbEls(e,f.posts[i].thumb||"")}l.init(e);e.on("change","input, textarea",function(){f.posts[i].modified=true});u.on("click",function(){$(this).attr("disabled",true);_(i)});e.find(".composer-discard").on("click",function(e){e.preventDefault();if(!f.posts[i].modified){m();k(i);return}var o=$(this).prop("disabled",true);t.translate("[[modules:composer.discard]]",function(e){bootbox.confirm(e,function(e){if(e){m();k(i)}o.prop("disabled",false)})})});c.on("input propertychange",function(){d.render(e)});c.on("scroll",function(){d.matchScroll(e)});d.render(e,function(){d.matchScroll(e)});c.val(p?p:s.body);a.init(e,s);x(e);P(e);if(typeof screenfull!=="undefined"&&!screenfull.enabled){$('[data-format="zen"]').addClass("hidden")}$(window).trigger("action:composer.enhanced")};function b(t){var i=f.posts[t];var o=config.allowTopicsThumbnail&&i.isMain,n=i?i.hasOwnProperty("cid"):false,a=i?!!i.isMain:false,r=i?!!i.pid:false,d=i?parseInt(i.uid,10)===0:false;var l=i.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");var m={title:l,mobile:f.bsEnvironment==="xs"||f.bsEnvironment==="sm",resizable:true,allowTopicsThumbnail:o,isTopicOrMain:n||a,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,isTopic:n,isEditing:r,showHandleInput:config.allowGuestHandles&&(app.user.uid===0||r&&d&&app.user.isAdmin),handle:i?i.handle||"":undefined,formatting:f.formatting,tagWhitelist:ajaxify.data.tagWhitelist};if(m.mobile){w()}y("composer",m,function(o){if($("#cmp-uuid-"+t).length){return}o=$(o);o.attr("id","cmp-uuid-"+t);$(document.body).append(o);var n=$(o[0]);c.reposition(n);f.enhance(n,t,i);s.init(n,f.posts[t]);T(t);n.on("click",function(){if(!e.isActive(t)){e.updateActive(t)}});c.handleResize(n);if(f.bsEnvironment==="xs"||f.bsEnvironment==="sm"){var a=n.find(".composer-submit"),r=n.find(".mobile-navbar .composer-submit"),d=n.find(".write"),l=d.attr("tabindex");a.removeAttr("tabindex");r.attr("tabindex",parseInt(l,10)+1);$(".category-name-container").on("click",function(){$(".category-selector").toggleClass("open")})}$(window).trigger("action:composer.loaded",{post_uuid:t,composerData:f.posts[t]});p.apply(n.find(".write"));P(n);E()})}function w(){var e="compose?p="+window.location.pathname,t=window.location.pathname.slice(1);if(t.startsWith(config.relative_path.slice(1))){t=t.slice(config.relative_path.length)}window.history.replaceState({url:null,returnPath:t},t,config.relative_path+"/"+t);window.history.pushState({url:e},e,config.relative_path+"/"+e)}function y(e,i,o){templates.parse(e,i,function(e){t.translate(e,o)})}function x(e){var t=e.find(".help");socket.emit("plugins.composer.renderHelp",function(e,i){if(!e&&i&&i.length>0){t.removeClass("hidden");t.on("click",function(){bootbox.alert(i)})}})}function T(e){if(f.active&&f.active!==e){f.minimize(f.active)}f.active=e}function P(e){setTimeout(function(){var t=e.find("input.title");if(t.length){t.focus()}else{e.find("textarea").focus().putCursorAtEnd()}},1)}function _(e){var t=f.posts[e];var i=$("#cmp-uuid-"+e);var n=i.find(".handle");var d=i.find(".title");var c=i.find("textarea");var l=i.find("input#topic-thumb-url");var p=t.hasOwnProperty("template")&&t.template.compose===true;d.val(d.val().trim());c.val(utils.rtrim(c.val()));if(l.length){l.val(l.val().trim())}var u=t.action;var g=(t.hasOwnProperty("cid")||parseInt(t.pid,10))&&i.find("input.title").length;var v=!g||g&&parseInt(t.cid,10);if(o.inProgress[e]&&o.inProgress[e].length){return h(e,"[[error:still-uploading]]")}else if(g&&d.val().length<parseInt(config.minimumTitleLength,10)){return h(e,"[[error:title-too-short, "+config.minimumTitleLength+"]]")}else if(g&&d.val().length>parseInt(config.maximumTitleLength,10)){return h(e,"[[error:title-too-long, "+config.maximumTitleLength+"]]")}else if(u==="topics.post"&&!v){return h(e,"[[error:category-not-selected]]")}else if(g&&s.getTags(e)&&s.getTags(e).length<parseInt(config.minimumTagsPerTopic,10)){return h(e,"[[error:not-enough-tags, "+config.minimumTagsPerTopic+"]]")}else if(c.val().length<parseInt(config.minimumPostLength,10)){return h(e,"[[error:content-too-short, "+config.minimumPostLength+"]]")}else if(c.val().length>parseInt(config.maximumPostLength,10)){return h(e,"[[error:content-too-long, "+config.maximumPostLength+"]]")}var b={};if(u==="topics.post"){b={handle:n?n.val():undefined,title:d.val(),content:c.val(),thumb:l.val()||"",cid:r.getSelectedCid(),tags:s.getTags(e)}}else if(u==="posts.reply"){b={tid:t.tid,handle:n?n.val():undefined,content:c.val(),toPid:t.toPid}}else if(u==="posts.edit"){b={pid:t.pid,handle:n?n.val():undefined,content:c.val(),title:d.val(),thumb:l.val()||"",tags:s.getTags(e)}}$(window).trigger("action:composer.submit",{composerEl:i,action:u,composerData:b});socket.emit(u,b,function(o,n){i.find(".composer-submit").removeAttr("disabled");if(o){if(o.message==="[[error:email-not-confirmed]]"){return app.showEmailConfirmWarning(o)}return app.alertError(o.message)}k(e);a.removeDraft(t.save_id);if(u==="topics.post"){ajaxify.go("topic/"+n.slug,undefined,p||f.bsEnvironment==="xs"||f.bsEnvironment==="sm"?true:false)}else if(u==="posts.reply"){if(p||f.bsEnvironment==="xs"||f.bsEnvironment==="sm"){window.history.back()}else if(ajaxify.data.template.topic){if(parseInt(t.tid,10)!==parseInt(ajaxify.data.tid,10)){ajaxify.go("post/"+n.pid)}}else{ajaxify.go("post/"+n.pid)}}else{m()}$(window).trigger("action:composer."+u,{composerData:b,data:n})})}function E(){$("html").addClass("composing")}function I(){$("body").css({paddingBottom:0});$("html").removeClass("composing")}function k(t){if(f.posts[t]){$("#cmp-uuid-"+t).remove();a.removeDraft(f.posts[t].save_id);delete f.posts[t];f.active=undefined;e.discard("composer",t);$('[data-action="post"]').removeAttr("disabled");$(window).trigger("action:composer.discard")}I()}f.minimize=function(t){var i=$("#cmp-uuid-"+t);i.css("visibility","hidden");f.active=undefined;e.minimize("composer",t);I()};return f});
//# sourceMappingURL=node_modules/nodebb-plugin-composer-default/static/lib/composer.js.map