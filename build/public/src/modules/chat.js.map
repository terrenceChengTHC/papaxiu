{"version":3,"sources":["public/src/modules/chat.js"],"names":["define","components","taskbar","S","sounds","Chats","ChatsMessages","translator","scrollStop","module","newMessage","prepareDOM","chatsToggleEl","get","chatsListEl","on","parent","hasClass","loadChatsDropdown","ev","$","target","parents","length","roomId","this","attr","ajaxify","currentPage","match","app","openChat","go","user","userslug","socket","emit","err","alertError","data","username","message","fromUser","isSelf","self","modalExists","modal","getModal","appendChatMessage","find","is","updateActive","scrollToBottom","toggleNew","isFocused","alternatingTitle","play","mid","push","title","roomName","touid","uid","roomData","users","filter","parseInt","silent","createModal","updateUserStatus","status","newTitle","html","newName","text","val","updateTitle","onChatMessageEdit","after","rooms","room","teaser","templates","parse","translate","translated","empty","createUserTooltips","bringModalToTop","chatModal","topZ","each","thisZ","css","callback","parseAndTranslate","uuid","utils","generateUUID","dragged","appendTo","timeago","center","loadJQueryUI","resizable","handles","minHeight","minWidth","event","ui","originalSize","height","size","calculateChatListHeight","draggable","start","stop","focus","distance","handle","apply","close","gotoChats","window","one","minimize","e","which","addEditDeleteHandler","messagesEl","toggle","addRenameHandler","addSendHandlers","createTagsInput","createAutoComplete","addScrollHandler","addCharactersLeftHandler","icon","state","trigger","focusInput","clearInterval","remove","discard","disableMobileBehaviour","hideAfter","removeClass","Math","max","width","outerWidth","scrollLeft","outerHeight","addClass","load","env","findBootstrapEnvironment","enableMobileBehaviour","modalEl","toggleNavbar","totalHeight","padding","contentMargin","inputGroupHeight"],"mappings":"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","file":"public/src/modules/chat.js","sourcesContent":["'use strict';\n\n\ndefine('chat', [\n\t'components',\n\t'taskbar',\n\t'string',\n\t'sounds',\n\t'forum/chats',\n\t'forum/chats/messages',\n\t'translator',\n\t'scrollStop',\n], function (components, taskbar, S, sounds, Chats, ChatsMessages, translator, scrollStop) {\n\tvar module = {};\n\tvar newMessage = false;\n\n\tmodule.prepareDOM = function () {\n\t\tvar chatsToggleEl = components.get('chat/dropdown');\n\t\tvar chatsListEl = components.get('chat/list');\n\n\t\tchatsToggleEl.on('click', function () {\n\t\t\tif (chatsToggleEl.parent().hasClass('open')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tmodule.loadChatsDropdown(chatsListEl);\n\t\t});\n\n\t\tchatsListEl.on('click', '[data-roomid]', function (ev) {\n\t\t\tif ($(ev.target).parents('.user-link').length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar roomId = $(this).attr('data-roomid');\n\t\t\tif (!ajaxify.currentPage.match(/^chats\\//)) {\n\t\t\t\tapp.openChat(roomId);\n\t\t\t} else {\n\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + roomId);\n\t\t\t}\n\t\t});\n\n\t\t$('[component=\"chats/mark-all-read\"]').on('click', function () {\n\t\t\tsocket.emit('modules.chats.markAllRead', function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tvar username = data.message.fromUser.username;\n\t\t\tvar isSelf = data.self === 1;\n\t\t\tdata.message.self = data.self;\n\n\t\t\tnewMessage = data.self === 0;\n\t\t\tif (module.modalExists(data.roomId)) {\n\t\t\t\tvar modal = module.getModal(data.roomId);\n\n\t\t\t\tChatsMessages.appendChatMessage(modal.find('.chat-content'), data.message);\n\n\t\t\t\tif (modal.is(':visible')) {\n\t\t\t\t\ttaskbar.updateActive(modal.attr('UUID'));\n\t\t\t\t\tChatsMessages.scrollToBottom(modal.find('.chat-content'));\n\t\t\t\t} else {\n\t\t\t\t\tmodule.toggleNew(modal.attr('UUID'), true, true);\n\t\t\t\t}\n\n\t\t\t\tif (!isSelf && (!modal.is(':visible') || !app.isFocused)) {\n\t\t\t\t\tapp.alternatingTitle('[[modules:chat.user_has_messaged_you, ' + username + ']]');\n\t\t\t\t\tsounds.play('chat-incoming', 'chat.incoming:' + data.message.mid);\n\n\t\t\t\t\ttaskbar.push('chat', modal.attr('UUID'), {\n\t\t\t\t\t\ttitle: data.roomName || username,\n\t\t\t\t\t\ttouid: data.message.fromUser.uid,\n\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tsocket.emit('modules.chats.loadRoom', {\n\t\t\t\t\troomId: data.roomId,\n\t\t\t\t}, function (err, roomData) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\troomData.users = roomData.users.filter(function (user) {\n\t\t\t\t\t\treturn user && parseInt(user.uid, 10) !== parseInt(app.user.uid, 10);\n\t\t\t\t\t});\n\t\t\t\t\troomData.silent = true;\n\t\t\t\t\troomData.uid = app.user.uid;\n\t\t\t\t\tmodule.createModal(roomData, function (modal) {\n\t\t\t\t\t\tmodule.toggleNew(modal.attr('UUID'), !isSelf, true);\n\t\t\t\t\t\tif (!isSelf) {\n\t\t\t\t\t\t\tapp.alternatingTitle('[[modules:chat.user_has_messaged_you, ' + username + ']]');\n\t\t\t\t\t\t\tsounds.play('chat-incoming', 'chat.incoming:' + data.message.mid);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tvar modal = module.getModal(data.uid);\n\t\t\tapp.updateUserStatus(modal.find('[component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\tvar newTitle = $('<div/>').html(data.newName).text();\n\t\t\tvar modal = module.getModal(data.roomId);\n\t\t\tmodal.find('[component=\"chat/room/name\"]').val(newTitle);\n\t\t\ttaskbar.updateTitle('chat', modal.attr('UUID'), newTitle);\n\t\t});\n\n\t\tChatsMessages.onChatMessageEdit();\n\t};\n\n\tmodule.loadChatsDropdown = function (chatsListEl) {\n\t\tsocket.emit('modules.chats.getRecentChats', {\n\t\t\tuid: app.user.uid,\n\t\t\tafter: 0,\n\t\t}, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tvar rooms = data.rooms.filter(function (room) {\n\t\t\t\treturn room.teaser;\n\t\t\t});\n\n\t\t\ttemplates.parse('partials/chats/dropdown', {\n\t\t\t\trooms: rooms,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\tchatsListEl.empty().html(translated);\n\t\t\t\t\tapp.createUserTooltips(chatsListEl, 'right');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tmodule.bringModalToTop = function (chatModal) {\n\t\tvar topZ = 0;\n\n\t\ttaskbar.updateActive(chatModal.attr('UUID'));\n\n\t\tif ($('.chat-modal').length === 1) {\n\t\t\treturn;\n\t\t}\n\t\t$('.chat-modal').each(function () {\n\t\t\tvar thisZ = parseInt($(this).css('zIndex'), 10);\n\t\t\tif (thisZ > topZ) {\n\t\t\t\ttopZ = thisZ;\n\t\t\t}\n\t\t});\n\n\t\tchatModal.css('zIndex', topZ + 1);\n\t};\n\n\tmodule.getModal = function (roomId) {\n\t\treturn $('#chat-modal-' + roomId);\n\t};\n\n\tmodule.modalExists = function (roomId) {\n\t\treturn $('#chat-modal-' + roomId).length !== 0;\n\t};\n\n\tmodule.createModal = function (data, callback) {\n\t\tapp.parseAndTranslate('chat', data, function (chatModal) {\n\t\t\tvar uuid = utils.generateUUID();\n\t\t\tvar dragged = false;\n\n\t\t\tchatModal.attr('id', 'chat-modal-' + data.roomId);\n\t\t\tchatModal.attr('data-roomid', data.roomId);\n\t\t\tchatModal.attr('intervalId', 0);\n\t\t\tchatModal.attr('UUID', uuid);\n\t\t\tchatModal.css('position', 'fixed');\n\t\t\tchatModal.css('zIndex', 100);\n\t\t\tchatModal.appendTo($('body'));\n\t\t\tchatModal.find('.timeago').timeago();\n\t\t\tmodule.center(chatModal);\n\n\t\t\tapp.loadJQueryUI(function () {\n\t\t\t\tchatModal.find('.modal-content').resizable({\n\t\t\t\t\thandles: 'n, e, s, w, se',\n\t\t\t\t\tminHeight: 250,\n\t\t\t\t\tminWidth: 400,\n\t\t\t\t});\n\n\t\t\t\tchatModal.find('.modal-content').on('resize', function (event, ui) {\n\t\t\t\t\tif (ui.originalSize.height === ui.size.height) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tchatModal.find('.chat-content').css('height', module.calculateChatListHeight(chatModal));\n\t\t\t\t});\n\n\t\t\t\tchatModal.draggable({\n\t\t\t\t\tstart: function () {\n\t\t\t\t\t\tmodule.bringModalToTop(chatModal);\n\t\t\t\t\t},\n\t\t\t\t\tstop: function () {\n\t\t\t\t\t\tchatModal.find('#chat-message-input').focus();\n\t\t\t\t\t},\n\t\t\t\t\tdistance: 10,\n\t\t\t\t\thandle: '.modal-header',\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tscrollStop.apply(chatModal.find('[component=\"chat/messages\"]'));\n\n\t\t\tchatModal.find('#chat-close-btn').on('click', function () {\n\t\t\t\tmodule.close(chatModal);\n\t\t\t});\n\n\t\t\tfunction gotoChats() {\n\t\t\t\tvar text = components.get('chat/input').val();\n\t\t\t\t$(window).one('action:ajaxify.end', function () {\n\t\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t\t});\n\n\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + chatModal.attr('data-roomid'));\n\t\t\t\tmodule.close(chatModal);\n\t\t\t}\n\n\t\t\tchatModal.find('.modal-header').on('dblclick', gotoChats);\n\t\t\tchatModal.find('button[data-action=\"maximize\"]').on('click', gotoChats);\n\t\t\tchatModal.find('button[data-action=\"minimize\"]').on('click', function () {\n\t\t\t\tvar uuid = chatModal.attr('uuid');\n\t\t\t\tmodule.minimize(uuid);\n\t\t\t});\n\n\t\t\tchatModal.on('click', function () {\n\t\t\t\tmodule.bringModalToTop(chatModal);\n\n\t\t\t\tif (dragged) {\n\t\t\t\t\tdragged = false;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tchatModal.on('mousemove', function (e) {\n\t\t\t\tif (e.which === 1) {\n\t\t\t\t\tdragged = true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tchatModal.on('mousemove keypress click', function () {\n\t\t\t\tif (newMessage) {\n\t\t\t\t\tsocket.emit('modules.chats.markRead', data.roomId);\n\t\t\t\t\tnewMessage = false;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tChats.addEditDeleteHandler(chatModal.find('[component=\"chat/messages\"]'), data.roomId);\n\n\t\t\tchatModal.find('[component=\"chat/controlsToggle\"]').on('click', function () {\n\t\t\t\tvar messagesEl = chatModal.find('[component=\"chat/messages\"]');\n\n\t\t\t\tchatModal.find('[component=\"chat/controls\"]').toggle();\n\t\t\t\tmessagesEl.css('height', module.calculateChatListHeight(chatModal));\n\t\t\t});\n\n\t\t\tChats.addRenameHandler(chatModal.attr('data-roomid'), chatModal.find('[component=\"chat/room/name\"]'));\n\n\t\t\tChats.addSendHandlers(chatModal.attr('data-roomid'), chatModal.find('#chat-message-input'), chatModal.find('#chat-message-send-btn'));\n\n\t\t\tChats.createTagsInput(chatModal.find('.users-tag-input'), data);\n\t\t\tChats.createAutoComplete(chatModal.find('[component=\"chat/input\"]'));\n\n\t\t\tChats.addScrollHandler(chatModal.attr('data-roomid'), data.uid, chatModal.find('.chat-content'));\n\n\t\t\tChats.addCharactersLeftHandler(chatModal.find('[component=\"chat/input\"]'));\n\n\t\t\ttaskbar.push('chat', chatModal.attr('UUID'), {\n\t\t\t\ttitle: data.roomName || (data.users.length ? data.users[0].username : ''),\n\t\t\t\troomId: data.roomId,\n\t\t\t\ticon: 'fa-comment',\n\t\t\t\tstate: '',\n\t\t\t});\n\n\t\t\t$(window).trigger('action:chat.loaded', chatModal);\n\n\t\t\tif (typeof callback === 'function') {\n\t\t\t\tcallback(chatModal);\n\t\t\t}\n\t\t});\n\t};\n\n\tmodule.focusInput = function (chatModal) {\n\t\tchatModal.find('#chat-message-input').focus();\n\t};\n\n\tmodule.close = function (chatModal) {\n\t\tclearInterval(chatModal.attr('intervalId'));\n\t\tchatModal.attr('intervalId', 0);\n\t\tchatModal.remove();\n\t\tchatModal.data('modal', null);\n\t\ttaskbar.discard('chat', chatModal.attr('UUID'));\n\n\t\tif (chatModal.attr('data-mobile')) {\n\t\t\tmodule.disableMobileBehaviour(chatModal);\n\t\t}\n\t};\n\n\tmodule.center = function (chatModal) {\n\t\tvar hideAfter = false;\n\t\tif (chatModal.hasClass('hide')) {\n\t\t\tchatModal.removeClass('hide');\n\t\t\thideAfter = true;\n\t\t}\n\t\tchatModal.css('left', Math.max(0, (($(window).width() - $(chatModal).outerWidth()) / 2) + $(window).scrollLeft()) + 'px');\n\t\tchatModal.css('top', Math.max(0, ($(window).height() / 2) - ($(chatModal).outerHeight() / 2)) + 'px');\n\n\t\tif (hideAfter) {\n\t\t\tchatModal.addClass('hide');\n\t\t}\n\t\treturn chatModal;\n\t};\n\n\tmodule.load = function (uuid) {\n\t\tvar chatModal = $('div[UUID=\"' + uuid + '\"]');\n\t\tchatModal.removeClass('hide');\n\t\ttaskbar.updateActive(uuid);\n\t\tChatsMessages.scrollToBottom(chatModal.find('.chat-content'));\n\t\tmodule.bringModalToTop(chatModal);\n\t\tmodule.focusInput(chatModal);\n\t\tsocket.emit('modules.chats.markRead', chatModal.attr('data-roomid'));\n\n\t\tvar env = utils.findBootstrapEnvironment();\n\t\tif (env === 'xs' || env === 'sm') {\n\t\t\tmodule.enableMobileBehaviour(chatModal);\n\t\t}\n\t};\n\n\tmodule.enableMobileBehaviour = function (modalEl) {\n\t\tapp.toggleNavbar(false);\n\t\tmodalEl.attr('data-mobile', '1');\n\t\tvar messagesEl = modalEl.find('.chat-content');\n\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\n\n\t\t$(window).on('resize', function () {\n\t\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\n\t\t});\n\t};\n\n\tmodule.disableMobileBehaviour = function () {\n\t\tapp.toggleNavbar(true);\n\t};\n\n\tmodule.calculateChatListHeight = function (modalEl) {\n\t\tvar totalHeight = modalEl.find('.modal-content').outerHeight() - modalEl.find('.modal-header').outerHeight();\n\t\tvar padding = parseInt(modalEl.find('.modal-body').css('padding-top'), 10) + parseInt(modalEl.find('.modal-body').css('padding-bottom'), 10);\n\t\tvar contentMargin = parseInt(modalEl.find('.chat-content').css('margin-top'), 10) + parseInt(modalEl.find('.chat-content').css('margin-bottom'), 10);\n\t\tvar inputGroupHeight = modalEl.find('.input-group').outerHeight();\n\n\t\treturn totalHeight - padding - contentMargin - inputGroupHeight;\n\t};\n\n\tmodule.minimize = function (uuid) {\n\t\tvar chatModal = $('div[UUID=\"' + uuid + '\"]');\n\t\tchatModal.addClass('hide');\n\t\ttaskbar.minimize('chat', uuid);\n\t\tclearInterval(chatModal.attr('intervalId'));\n\t\tchatModal.attr('intervalId', 0);\n\t};\n\n\tmodule.toggleNew = taskbar.toggleNew;\n\n\n\treturn module;\n});\n"]}