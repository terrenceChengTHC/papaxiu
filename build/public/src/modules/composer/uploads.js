"use strict";define("composer/uploads",["composer/preview","composer/categoryList","translator"],function(e,t,i){var r={inProgress:{}};var a;var n="uploading 0%";r.getCid=function(){return a};r.initialize=function(e,t){a=t;f(e);l(e);o(e);s(e);i.translate("[[modules:composer.uploading, "+0+"%]]",function(e){n=e})};function o(e){var t=$("#cmp-uuid-"+e);t.find("#files").on("change",function(t){var i=(t.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null);if(i){d({files:i,post_uuid:e,route:"/api/post/upload"})}});t.find("#topic-thumb-file").on("change",function(t){var i=(t.target||{}).files||($(this).val()?[{name:$(this).val(),type:utils.fileMimeType($(this).val())}]:null),r;if(i){if(window.FormData){r=new FormData;for(var a=0;a<i.length;++a){r.append("files[]",i[a],i[a].name)}}m({files:i,post_uuid:e,route:"/api/topic/thumb/upload",formData:r})}})}function s(e){var t=$("#cmp-uuid-"+e);t.on("click",".topic-thumb-clear-btn",function(e){t.find("input#topic-thumb-url").val("").trigger("change");u(t.find("input#topic-thumb-file"));$(this).addClass("hide");e.preventDefault()});t.on("paste change keypress","input#topic-thumb-url",function(){var e=$(this);setTimeout(function(){var i=e.val();if(i){t.find(".topic-thumb-clear-btn").removeClass("hide")}else{u(t.find("input#topic-thumb-file"));t.find(".topic-thumb-clear-btn").addClass("hide")}t.find("img.topic-thumb-preview").attr("src",i)},100)})}r.toggleThumbEls=function(e,t){var i=e.find(".topic-thumb-toggle-btn");e.find("input#topic-thumb-url").val(t);e.find("img.topic-thumb-preview").attr("src",t);if(t){e.find(".topic-thumb-clear-btn").removeClass("hide")}i.removeClass("hide");i.off("click").on("click",function(){var t=e.find(".topic-thumb-container");t.toggleClass("hide",!t.hasClass("hide"))})};function u(e){e.wrap("<form />").closest("form").get(0).reset();e.unwrap()}function f(e){function t(){if(a){return}o.css("top","0px");o.css("height",n.height()+"px");o.css("line-height",n.height()+"px");o.show();o.on("dragleave",function(){o.hide();o.off("dragleave")})}function i(t){t.preventDefault();var i=t.originalEvent.dataTransfer.files;var r;if(i.length){if(window.FormData){r=new FormData;for(var a=0;a<i.length;++a){r.append("files[]",i[a],i[a].name)}}d({files:i,post_uuid:e,route:"/api/post/upload",formData:r})}o.hide();return false}function r(e){e.preventDefault();return false}var a=false;var n=$("#cmp-uuid-"+e);var o=n.find(".imagedrop");$(document).off("dragstart").on("dragstart",function(){a=true}).off("dragend").on("dragend",function(){a=false});n.on("dragenter",t);o.on("dragover",r);o.on("dragenter",r);o.on("drop",i)}function l(e){$(window).off("paste").on("paste",function(t){var i=(t.clipboardData||t.originalEvent.clipboardData||{}).items;[].some.call(i,function(t){var i=t.getAsFile();if(!i){return false}var r=utils.generateUUID()+"-"+i.name;var a=null;if(window.FormData){a=new FormData;a.append("files[]",i,r)}d({files:[i],fileNames:[r],post_uuid:e,route:"/api/post/upload",formData:a});return true})})}function c(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function p(e,t,i){return e.slice(0,t)+i+e.slice(t)}function d(o){var s=o.files;var u=o.post_uuid;var f=$("#cmp-uuid-"+u);var l=f.find("textarea");var d=l.val();var m=f.find("#fileForm");m.attr("action",config.relative_path+o.route);a=t.getSelectedCid();if(!a&&ajaxify.data.cid){a=ajaxify.data.cid}var h=[];for(var v=0;v<s.length;++v){h.push(v+"_"+Date.now()+"_"+(o.fileNames?o.fileNames[v]:s[v].name));var b=s[v].type.match(/image./);if(s[v].size>parseInt(config.maximumFileSize,10)*1024){m[0].reset();return app.alertError("[[error:file-too-big, "+config.maximumFileSize+"]]")}d=p(d,l.getCursorPosition(),(b?"!":"")+"["+h[v]+"]("+n+") ")}l.val(d);m.off("submit").submit(function(){function t(e,t){var i=l.val();var r=new RegExp(c(e)+"]\\([^)]+\\)","g");l.val(i.replace(r,e+"]("+t+")"))}r.inProgress[u]=r.inProgress[u]||[];r.inProgress[u].push(1);if(o.formData){o.formData.append("cid",a)}$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},resetForm:true,clearForm:true,formData:o.formData,data:{cid:a},error:g,uploadProgress:function(e,r,a,n){i.translate("[[modules:composer.uploading, "+n+"%]]",function(e){for(var i=0;i<s.length;++i){t(h[i],e)}})},success:function(i){if(i&&i.length){for(var r=0;r<i.length;++r){t(h[r],i[r].url)}}e.render(f);l.focus()},complete:function(){m[0].reset();r.inProgress[u].pop()}});return false});m.submit()}function m(e){var t=e.post_uuid,i=$("#cmp-uuid-"+t),a=i.find(".topic-thumb-spinner"),n=i.find("#thumbForm");n.attr("action",config.relative_path+e.route);n.off("submit").submit(function(){a.removeClass("hide");r.inProgress[t]=r.inProgress[t]||[];r.inProgress[t].push(1);$(this).ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},formData:e.formData,error:g,success:function(e){i.find("#topic-thumb-url").val((e[0]||{}).url||"").trigger("change")},complete:function(){r.inProgress[t].pop();a.addClass("hide")}});return false});n.submit()}function g(e){var t=e.responseJSON&&e.responseJSON.error||"[[error:parse-error]]";if(e&&e.status===413){t=e.statusText||"Request Entity Too Large"}app.alertError(t)}return r});
//# sourceMappingURL=node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js.map