{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js"],"names":["define","preview","categoryList","translator","uploads","inProgress","cid","uploadingText","getCid","initialize","post_uuid","_cid","initializeDragAndDrop","initializePaste","addChangeHandlers","addTopicThumbHandlers","translate","translated","postContainer","$","find","on","e","files","target","this","val","name","type","utils","fileMimeType","uploadContentFiles","route","fd","window","FormData","i","length","append","uploadTopicThumb","formData","trigger","resetInputFile","addClass","preventDefault","urlEl","setTimeout","url","removeClass","attr","toggleThumbEls","thumbToggleBtnEl","off","container","toggleClass","hasClass","$el","wrap","closest","get","reset","unwrap","onDragEnter","draggingDocument","drop","css","height","show","hide","onDragDrop","originalEvent","dataTransfer","cancel","document","event","items","clipboardData","some","call","item","blob","getAsFile","blobName","generateUUID","fileNames","escapeRegExp","text","replace","insertText","str","index","insert","slice","params","textarea","uploadForm","config","relative_path","getSelectedCid","ajaxify","data","filenameMapping","push","Date","now","isImage","match","size","parseInt","maximumFileSize","app","alertError","getCursorPosition","submit","updateTextArea","filename","current","re","RegExp","ajaxSubmit","headers","x-csrf-token","csrf_token","resetForm","clearForm","error","onUploadError","uploadProgress","position","total","percent","success","render","focus","complete","pop","spinner","thumbForm","xhr","msg","responseJSON","status","statusText"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js","sourcesContent":["'use strict';\r\n\r\n/* globals define, utils, config, app */\r\n\r\ndefine('composer/uploads', [\r\n\t'composer/preview',\r\n\t'composer/categoryList',\r\n\t'translator',\r\n], function(preview, categoryList, translator) {\r\n\tvar uploads = {\r\n\t\tinProgress: {}\r\n\t};\r\n\r\n\tvar cid;\r\n\r\n\tvar uploadingText = 'uploading 0%';\r\n\r\n\tuploads.getCid = function() {\r\n\t\treturn cid;\r\n\t};\r\n\r\n\tuploads.initialize = function(post_uuid, _cid) {\r\n\t\tcid = _cid;\r\n\t\tinitializeDragAndDrop(post_uuid);\r\n\t\tinitializePaste(post_uuid);\r\n\r\n\t\taddChangeHandlers(post_uuid);\r\n\t\taddTopicThumbHandlers(post_uuid);\r\n\t\ttranslator.translate('[[modules:composer.uploading, ' + 0 + '%]]', function(translated) {\r\n\t\t\tuploadingText = translated;\r\n\t\t});\r\n\t};\r\n\r\n\tfunction addChangeHandlers(post_uuid) {\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\r\n\t\tpostContainer.find('#files').on('change', function(e) {\r\n\t\t\tvar files = (e.target || {}).files || ($(this).val() ? [{name: $(this).val(), type: utils.fileMimeType($(this).val())}] : null);\r\n\t\t\tif (files) {\r\n\t\t\t\tuploadContentFiles({files: files, post_uuid: post_uuid, route: '/api/post/upload'});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tpostContainer.find('#topic-thumb-file').on('change', function(e) {\r\n\t\t\tvar files = (e.target || {}).files || ($(this).val() ? [{name: $(this).val(), type: utils.fileMimeType($(this).val())}] : null),\r\n\t\t\t\tfd;\r\n\r\n\t\t\tif (files) {\r\n\t\t\t\tif (window.FormData) {\r\n\t\t\t\t\tfd = new FormData();\r\n\t\t\t\t\tfor (var i = 0; i < files.length; ++i) {\r\n\t\t\t\t\t\tfd.append('files[]', files[i], files[i].name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tuploadTopicThumb({files: files, post_uuid: post_uuid, route: '/api/topic/thumb/upload', formData: fd});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addTopicThumbHandlers(post_uuid) {\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\r\n\t\tpostContainer.on('click', '.topic-thumb-clear-btn', function(e) {\r\n\t\t\tpostContainer.find('input#topic-thumb-url').val('').trigger('change');\r\n\t\t\tresetInputFile(postContainer.find('input#topic-thumb-file'));\r\n\t\t\t$(this).addClass('hide');\r\n\t\t\te.preventDefault();\r\n\t\t});\r\n\r\n\t\tpostContainer.on('paste change keypress', 'input#topic-thumb-url', function() {\r\n\t\t\tvar urlEl = $(this);\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tvar url = urlEl.val();\r\n\t\t\t\tif (url) {\r\n\t\t\t\t\tpostContainer.find('.topic-thumb-clear-btn').removeClass('hide');\r\n\t\t\t\t} else {\r\n\t\t\t\t\tresetInputFile(postContainer.find('input#topic-thumb-file'));\r\n\t\t\t\t\tpostContainer.find('.topic-thumb-clear-btn').addClass('hide');\r\n\t\t\t\t}\r\n\t\t\t\tpostContainer.find('img.topic-thumb-preview').attr('src', url);\r\n\t\t\t}, 100);\r\n\t\t});\r\n\t}\r\n\r\n\tuploads.toggleThumbEls = function(postContainer, url) {\r\n\t\tvar thumbToggleBtnEl = postContainer.find('.topic-thumb-toggle-btn');\r\n\r\n\t\tpostContainer.find('input#topic-thumb-url').val(url);\r\n\t\tpostContainer.find('img.topic-thumb-preview').attr('src', url);\r\n\t\tif (url) {\r\n\t\t\tpostContainer.find('.topic-thumb-clear-btn').removeClass('hide');\r\n\t\t}\r\n\t\tthumbToggleBtnEl.removeClass('hide');\r\n\t\tthumbToggleBtnEl.off('click').on('click', function() {\r\n\t\t\tvar container = postContainer.find('.topic-thumb-container');\r\n\t\t\tcontainer.toggleClass('hide', !container.hasClass('hide'));\r\n\t\t});\r\n\t};\r\n\r\n\tfunction resetInputFile($el) {\r\n\t\t$el.wrap('<form />').closest('form').get(0).reset();\r\n\t\t$el.unwrap();\r\n\t}\r\n\r\n\tfunction initializeDragAndDrop(post_uuid) {\r\n\r\n\t\tfunction onDragEnter() {\r\n\t\t\tif (draggingDocument) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tdrop.css('top', '0px');\r\n\t\t\tdrop.css('height', postContainer.height() + 'px');\r\n\t\t\tdrop.css('line-height', postContainer.height() + 'px');\r\n\t\t\tdrop.show();\r\n\r\n\t\t\tdrop.on('dragleave', function() {\r\n\t\t\t\tdrop.hide();\r\n\t\t\t\tdrop.off('dragleave');\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tfunction onDragDrop(e) {\r\n\t\t\te.preventDefault();\r\n\t\t\tvar files = e.originalEvent.dataTransfer.files;\r\n\t\t\tvar fd;\r\n\r\n\t\t\tif (files.length) {\r\n\t\t\t\tif (window.FormData) {\r\n\t\t\t\t\tfd = new FormData();\r\n\t\t\t\t\tfor (var i = 0; i < files.length; ++i) {\r\n\t\t\t\t\t\tfd.append('files[]', files[i], files[i].name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tuploadContentFiles({\r\n\t\t\t\t\tfiles: files,\r\n\t\t\t\t\tpost_uuid: post_uuid,\r\n\t\t\t\t\troute: '/api/post/upload',\r\n\t\t\t\t\tformData: fd\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tdrop.hide();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tfunction cancel(e) {\r\n\t\t\te.preventDefault();\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tvar draggingDocument = false;\r\n\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\t\tvar drop = postContainer.find('.imagedrop');\r\n\r\n\t\t$(document).off('dragstart').on('dragstart', function() {\r\n\t\t\tdraggingDocument = true;\r\n\t\t}).off('dragend').on('dragend', function() {\r\n\t\t\tdraggingDocument = false;\r\n\t\t});\r\n\r\n\t\tpostContainer.on('dragenter', onDragEnter);\r\n\r\n\t\tdrop.on('dragover', cancel);\r\n\t\tdrop.on('dragenter', cancel);\r\n\t\tdrop.on('drop', onDragDrop);\r\n\t}\r\n\r\n\tfunction initializePaste(post_uuid) {\r\n\t\t$(window).off('paste').on('paste', function(event) {\r\n\r\n\t\t\tvar items = (event.clipboardData || event.originalEvent.clipboardData || {}).items;\r\n\r\n\t\t\t[].some.call(items, function(item) {\r\n\t\t\t\tvar blob = item.getAsFile();\r\n\r\n\t\t\t\tif (!blob) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar blobName = utils.generateUUID() + '-' + blob.name;\r\n\r\n\t\t\t\tvar fd = null;\r\n\t\t\t\tif (window.FormData) {\r\n\t\t\t\t\tfd = new FormData();\r\n\t\t\t\t\tfd.append('files[]', blob, blobName);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tuploadContentFiles({\r\n\t\t\t\t\tfiles: [blob],\r\n\t\t\t\t\tfileNames: [blobName],\r\n\t\t\t\t\tpost_uuid: post_uuid,\r\n\t\t\t\t\troute: '/api/post/upload',\r\n\t\t\t\t\tformData: fd\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction escapeRegExp(text) {\r\n\t\treturn text.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\");\r\n\t}\r\n\r\n\tfunction insertText(str, index, insert) {\r\n\t\treturn str.slice(0, index) + insert + str.slice(index);\r\n\t}\r\n\r\n\tfunction uploadContentFiles(params) {\r\n\t\tvar files = params.files;\r\n\t\tvar post_uuid = params.post_uuid;\r\n\t\tvar postContainer = $('#cmp-uuid-' + post_uuid);\r\n\t\tvar textarea = postContainer.find('textarea');\r\n\t\tvar text = textarea.val();\r\n\t\tvar uploadForm = postContainer.find('#fileForm');\r\n\t\tuploadForm.attr('action', config.relative_path + params.route);\r\n\r\n\t\tcid = categoryList.getSelectedCid();\r\n\t\tif (!cid && ajaxify.data.cid) {\r\n\t\t\tcid = ajaxify.data.cid;\r\n\t\t}\r\n\r\n\t\tvar filenameMapping = [];\r\n\r\n\t\tfor (var i = 0; i < files.length; ++i) {\r\n\t\t\tfilenameMapping.push(i + '_' + Date.now() + '_' + (params.fileNames ? params.fileNames[i] : files[i].name));\r\n\t\t\tvar isImage = files[i].type.match(/image./);\r\n\r\n\t\t\tif (files[i].size > parseInt(config.maximumFileSize, 10) * 1024) {\r\n\t\t\t\tuploadForm[0].reset();\r\n\t\t\t\treturn app.alertError('[[error:file-too-big, ' + config.maximumFileSize + ']]');\r\n\t\t\t}\r\n\r\n\t\t\ttext = insertText(text, textarea.getCursorPosition(), (isImage ? '!' : '') + '[' + filenameMapping[i] + '](' + uploadingText + ') ');\r\n\t\t}\r\n\r\n\t\ttextarea.val(text);\r\n\r\n\t\tuploadForm.off('submit').submit(function() {\r\n\t\t\tfunction updateTextArea(filename, text) {\r\n\t\t\t\tvar current = textarea.val();\r\n\t\t\t\tvar re = new RegExp(escapeRegExp(filename) + \"]\\\\([^)]+\\\\)\", 'g');\r\n\t\t\t\ttextarea.val(current.replace(re, filename + '](' + text + ')'));\r\n\t\t\t}\r\n\r\n\t\t\tuploads.inProgress[post_uuid] = uploads.inProgress[post_uuid] || [];\r\n\t\t\tuploads.inProgress[post_uuid].push(1);\r\n\r\n\t\t\tif (params.formData) {\r\n\t\t\t\tparams.formData.append('cid', cid);\r\n\t\t\t}\r\n\r\n\t\t\t$(this).ajaxSubmit({\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'x-csrf-token': config.csrf_token\r\n\t\t\t\t},\r\n\t\t\t\tresetForm: true,\r\n\t\t\t\tclearForm: true,\r\n\t\t\t\tformData: params.formData,\r\n\t\t\t\tdata: {cid: cid},\r\n\r\n\t\t\t\terror: onUploadError,\r\n\r\n\t\t\t\tuploadProgress: function(event, position, total, percent) {\r\n\t\t\t\t\ttranslator.translate('[[modules:composer.uploading, ' + percent + '%]]', function(translated) {\r\n\t\t\t\t\t\tfor (var i=0; i < files.length; ++i) {\r\n\t\t\t\t\t\t\tupdateTextArea(filenameMapping[i], translated);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\r\n\t\t\t\tsuccess: function(uploads) {\r\n\t\t\t\t\tif (uploads && uploads.length) {\r\n\t\t\t\t\t\tfor(var i=0; i<uploads.length; ++i) {\r\n\t\t\t\t\t\t\tupdateTextArea(filenameMapping[i], uploads[i].url);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpreview.render(postContainer);\r\n\t\t\t\t\ttextarea.focus();\r\n\t\t\t\t},\r\n\r\n\t\t\t\tcomplete: function() {\r\n\t\t\t\t\tuploadForm[0].reset();\r\n\t\t\t\t\tuploads.inProgress[post_uuid].pop();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tuploadForm.submit();\r\n\t}\r\n\r\n\tfunction uploadTopicThumb(params) {\r\n\t\tvar post_uuid = params.post_uuid,\r\n\t\t\tpostContainer = $('#cmp-uuid-' + post_uuid),\r\n\t\t\tspinner = postContainer.find('.topic-thumb-spinner'),\r\n\t\t\tthumbForm = postContainer.find('#thumbForm');\r\n\r\n\t\tthumbForm.attr('action', config.relative_path + params.route);\r\n\r\n\t\tthumbForm.off('submit').submit(function() {\r\n\t\t\tspinner.removeClass('hide');\r\n\r\n\t\t\tuploads.inProgress[post_uuid] = uploads.inProgress[post_uuid] || [];\r\n\t\t\tuploads.inProgress[post_uuid].push(1);\r\n\r\n\t\t\t$(this).ajaxSubmit({\r\n\t\t\t\theaders: {\r\n\t\t\t\t\t'x-csrf-token': config.csrf_token\r\n\t\t\t\t},\r\n\t\t\t\tformData: params.formData,\r\n\t\t\t\terror: onUploadError,\r\n\t\t\t\tsuccess: function(uploads) {\r\n\t\t\t\t\tpostContainer.find('#topic-thumb-url').val((uploads[0] || {}).url || '').trigger('change');\r\n\t\t\t\t},\r\n\t\t\t\tcomplete: function() {\r\n\t\t\t\t\tuploads.inProgress[post_uuid].pop();\r\n\t\t\t\t\tspinner.addClass('hide');\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\t\tthumbForm.submit();\r\n\t}\r\n\r\n\tfunction onUploadError(xhr) {\r\n\t\tvar msg = (xhr.responseJSON && xhr.responseJSON.error) || '[[error:parse-error]]';\r\n\t\tif (xhr && xhr.status === 413) {\r\n\t\t\tmsg = xhr.statusText || 'Request Entity Too Large';\r\n\t\t}\r\n\t\tapp.alertError(msg);\r\n\t}\r\n\r\n\treturn uploads;\r\n});\r\n\r\n"]}