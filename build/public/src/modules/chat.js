"use strict";define("chat",["components","taskbar","string","sounds","forum/chats","forum/chats/messages","translator","scrollStop"],function(t,e,a,n,o,i,r,s){var c={};var d=false;c.prepareDOM=function(){var a=t.get("chat/dropdown");var o=t.get("chat/list");a.on("click",function(){if(a.parent().hasClass("open")){return}c.loadChatsDropdown(o)});o.on("click","[data-roomid]",function(t){if($(t.target).parents(".user-link").length){return}var e=$(this).attr("data-roomid");if(!ajaxify.currentPage.match(/^chats\//)){app.openChat(e)}else{ajaxify.go("user/"+app.user.userslug+"/chats/"+e)}});$('[component="chats/mark-all-read"]').on("click",function(){socket.emit("modules.chats.markAllRead",function(t){if(t){return app.alertError(t)}})});socket.on("event:chats.receive",function(t){var a=t.message.fromUser.username;var o=t.self===1;t.message.self=t.self;d=t.self===0;if(c.modalExists(t.roomId)){var r=c.getModal(t.roomId);i.appendChatMessage(r.find(".chat-content"),t.message);if(r.is(":visible")){e.updateActive(r.attr("UUID"));i.scrollToBottom(r.find(".chat-content"))}else{c.toggleNew(r.attr("UUID"),true,true)}if(!o&&(!r.is(":visible")||!app.isFocused)){app.alternatingTitle("[[modules:chat.user_has_messaged_you, "+a+"]]");n.play("chat-incoming","chat.incoming:"+t.message.mid);e.push("chat",r.attr("UUID"),{title:t.roomName||a,touid:t.message.fromUser.uid,roomId:t.roomId})}}else{socket.emit("modules.chats.loadRoom",{roomId:t.roomId},function(e,i){if(e){return app.alertError(e.message)}i.users=i.users.filter(function(t){return t&&parseInt(t.uid,10)!==parseInt(app.user.uid,10)});i.silent=true;i.uid=app.user.uid;c.createModal(i,function(e){c.toggleNew(e.attr("UUID"),!o,true);if(!o){app.alternatingTitle("[[modules:chat.user_has_messaged_you, "+a+"]]");n.play("chat-incoming","chat.incoming:"+t.message.mid)}})})}});socket.on("event:user_status_change",function(t){var e=c.getModal(t.uid);app.updateUserStatus(e.find('[component="user/status"]'),t.status)});socket.on("event:chats.roomRename",function(t){var a=$("<div/>").html(t.newName).text();var n=c.getModal(t.roomId);n.find('[component="chat/room/name"]').val(a);e.updateTitle("chat",n.attr("UUID"),a)});i.onChatMessageEdit()};c.loadChatsDropdown=function(t){socket.emit("modules.chats.getRecentChats",{uid:app.user.uid,after:0},function(e,a){if(e){return app.alertError(e.message)}var n=a.rooms.filter(function(t){return t.teaser});templates.parse("partials/chats/dropdown",{rooms:n},function(e){r.translate(e,function(e){t.empty().html(e);app.createUserTooltips(t,"right")})})})};c.bringModalToTop=function(t){var a=0;e.updateActive(t.attr("UUID"));if($(".chat-modal").length===1){return}$(".chat-modal").each(function(){var t=parseInt($(this).css("zIndex"),10);if(t>a){a=t}});t.css("zIndex",a+1)};c.getModal=function(t){return $("#chat-modal-"+t)};c.modalExists=function(t){return $("#chat-modal-"+t).length!==0};c.createModal=function(a,n){app.parseAndTranslate("chat",a,function(i){var r=utils.generateUUID();var l=false;i.attr("id","chat-modal-"+a.roomId);i.attr("data-roomid",a.roomId);i.attr("intervalId",0);i.attr("UUID",r);i.css("position","fixed");i.css("zIndex",100);i.appendTo($("body"));i.find(".timeago").timeago();c.center(i);app.loadJQueryUI(function(){i.find(".modal-content").resizable({handles:"n, e, s, w, se",minHeight:250,minWidth:400});i.find(".modal-content").on("resize",function(t,e){if(e.originalSize.height===e.size.height){return}i.find(".chat-content").css("height",c.calculateChatListHeight(i))});i.draggable({start:function(){c.bringModalToTop(i)},stop:function(){i.find("#chat-message-input").focus()},distance:10,handle:".modal-header"})});s.apply(i.find('[component="chat/messages"]'));i.find("#chat-close-btn").on("click",function(){c.close(i)});function u(){var e=t.get("chat/input").val();$(window).one("action:ajaxify.end",function(){t.get("chat/input").val(e)});ajaxify.go("user/"+app.user.userslug+"/chats/"+i.attr("data-roomid"));c.close(i)}i.find(".modal-header").on("dblclick",u);i.find('button[data-action="maximize"]').on("click",u);i.find('button[data-action="minimize"]').on("click",function(){var t=i.attr("uuid");c.minimize(t)});i.on("click",function(){c.bringModalToTop(i);if(l){l=false}});i.on("mousemove",function(t){if(t.which===1){l=true}});i.on("mousemove keypress click",function(){if(d){socket.emit("modules.chats.markRead",a.roomId);d=false}});o.addEditDeleteHandler(i.find('[component="chat/messages"]'),a.roomId);i.find('[component="chat/controlsToggle"]').on("click",function(){var t=i.find('[component="chat/messages"]');i.find('[component="chat/controls"]').toggle();t.css("height",c.calculateChatListHeight(i))});o.addRenameHandler(i.attr("data-roomid"),i.find('[component="chat/room/name"]'));o.addSendHandlers(i.attr("data-roomid"),i.find("#chat-message-input"),i.find("#chat-message-send-btn"));o.createTagsInput(i.find(".users-tag-input"),a);o.createAutoComplete(i.find('[component="chat/input"]'));o.addScrollHandler(i.attr("data-roomid"),a.uid,i.find(".chat-content"));o.addCharactersLeftHandler(i.find('[component="chat/input"]'));e.push("chat",i.attr("UUID"),{title:a.roomName||(a.users.length?a.users[0].username:""),roomId:a.roomId,icon:"fa-comment",state:""});$(window).trigger("action:chat.loaded",i);if(typeof n==="function"){n(i)}})};c.focusInput=function(t){t.find("#chat-message-input").focus()};c.close=function(t){clearInterval(t.attr("intervalId"));t.attr("intervalId",0);t.remove();t.data("modal",null);e.discard("chat",t.attr("UUID"));if(t.attr("data-mobile")){c.disableMobileBehaviour(t)}};c.center=function(t){var e=false;if(t.hasClass("hide")){t.removeClass("hide");e=true}t.css("left",Math.max(0,($(window).width()-$(t).outerWidth())/2+$(window).scrollLeft())+"px");t.css("top",Math.max(0,$(window).height()/2-$(t).outerHeight()/2)+"px");if(e){t.addClass("hide")}return t};c.load=function(t){var a=$('div[UUID="'+t+'"]');a.removeClass("hide");e.updateActive(t);i.scrollToBottom(a.find(".chat-content"));c.bringModalToTop(a);c.focusInput(a);socket.emit("modules.chats.markRead",a.attr("data-roomid"));var n=utils.findBootstrapEnvironment();if(n==="xs"||n==="sm"){c.enableMobileBehaviour(a)}};c.enableMobileBehaviour=function(t){app.toggleNavbar(false);t.attr("data-mobile","1");var e=t.find(".chat-content");e.css("height",c.calculateChatListHeight(t));$(window).on("resize",function(){e.css("height",c.calculateChatListHeight(t))})};c.disableMobileBehaviour=function(){app.toggleNavbar(true)};c.calculateChatListHeight=function(t){var e=t.find(".modal-content").outerHeight()-t.find(".modal-header").outerHeight();var a=parseInt(t.find(".modal-body").css("padding-top"),10)+parseInt(t.find(".modal-body").css("padding-bottom"),10);var n=parseInt(t.find(".chat-content").css("margin-top"),10)+parseInt(t.find(".chat-content").css("margin-bottom"),10);var o=t.find(".input-group").outerHeight();return e-a-n-o};c.minimize=function(t){var a=$('div[UUID="'+t+'"]');a.addClass("hide");e.minimize("chat",t);clearInterval(a.attr("intervalId"));a.attr("intervalId",0)};c.toggleNew=e.toggleNew;return c});
//# sourceMappingURL=public/src/modules/chat.js.map