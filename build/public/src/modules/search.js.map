{"version":3,"sources":["public/src/modules/search.js"],"names":["define","nav","translator","storage","Search","current","query","data","callback","term","topicSearch","match","replace","encodeURIComponent","e","app","alertError","ajaxify","go","createQueryString","cleanedTerm","tid","length","queryTopic","searchIn","in","postedBy","by","categories","searchChildren","hasTags","parseInt","replies","repliesFilter","timeRange","timeFilter","sortBy","sortDirection","showAs","$","window","trigger","decodeURIComponent","param","getSearchPreferences","JSON","parse","getItem","socket","emit","err","pids","message","Array","isArray","results","sort","a","b","checkPagePresence","topicDOM","update","active","prev","index","next","topicSearchEl","start","find","html","removeAttr","pid","topicPostSort","config","postIndex","scrollToPost","translate","text","removeClass","attr","require","mousetrap","bind","end","addClass","unbind"],"mappings":"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","file":"public/src/modules/search.js","sourcesContent":["'use strict';\n\n\ndefine('search', ['navigator', 'translator', 'storage'], function (nav, translator, storage) {\n\tvar Search = {\n\t\tcurrent: {},\n\t};\n\n\tSearch.query = function (data, callback) {\n\t\tvar term = data.term;\n\n\t\t// Detect if a tid was specified\n\t\tvar topicSearch = term.match(/^in:topic-([\\d]+) /);\n\n\t\tif (!topicSearch) {\n\t\t\tterm = term.replace(/^[ ?#]*/, '');\n\n\t\t\ttry {\n\t\t\t\tterm = encodeURIComponent(term);\n\t\t\t} catch (e) {\n\t\t\t\treturn app.alertError('[[error:invalid-search-term]]');\n\t\t\t}\n\n\t\t\tajaxify.go('search?' + createQueryString(data));\n\t\t\tcallback();\n\t\t} else {\n\t\t\tvar cleanedTerm = term.replace(topicSearch[0], '');\n\t\t\tvar tid = topicSearch[1];\n\n\t\t\tif (cleanedTerm.length > 0) {\n\t\t\t\tSearch.queryTopic(tid, cleanedTerm, callback);\n\t\t\t}\n\t\t}\n\t};\n\n\tfunction createQueryString(data) {\n\t\tvar searchIn = data.in || 'titlesposts';\n\t\tvar postedBy = data.by || '';\n\t\tvar query = {\n\t\t\tterm: data.term,\n\t\t\tin: searchIn,\n\t\t};\n\n\t\tif (postedBy && (searchIn === 'posts' || searchIn === 'titles' || searchIn === 'titlesposts')) {\n\t\t\tquery.by = postedBy;\n\t\t}\n\n\t\tif (data.categories && data.categories.length) {\n\t\t\tquery.categories = data.categories;\n\t\t\tif (data.searchChildren) {\n\t\t\t\tquery.searchChildren = data.searchChildren;\n\t\t\t}\n\t\t}\n\n\t\tif (data.hasTags && data.hasTags.length) {\n\t\t\tquery.hasTags = data.hasTags;\n\t\t}\n\n\t\tif (parseInt(data.replies, 10) > 0) {\n\t\t\tquery.replies = data.replies;\n\t\t\tquery.repliesFilter = data.repliesFilter || 'atleast';\n\t\t}\n\n\t\tif (data.timeRange) {\n\t\t\tquery.timeRange = data.timeRange;\n\t\t\tquery.timeFilter = data.timeFilter || 'newer';\n\t\t}\n\n\t\tif (data.sortBy) {\n\t\t\tquery.sortBy = data.sortBy;\n\t\t\tquery.sortDirection = data.sortDirection;\n\t\t}\n\n\t\tif (data.showAs) {\n\t\t\tquery.showAs = data.showAs;\n\t\t}\n\n\t\t$(window).trigger('action:search.createQueryString', {\n\t\t\tquery: query,\n\t\t\tdata: data,\n\t\t});\n\n\t\treturn decodeURIComponent($.param(query));\n\t}\n\n\tSearch.getSearchPreferences = function () {\n\t\ttry {\n\t\t\treturn JSON.parse(storage.getItem('search-preferences') || '{}');\n\t\t} catch (e) {\n\t\t\treturn {};\n\t\t}\n\t};\n\n\tSearch.queryTopic = function (tid, term) {\n\t\tsocket.emit('topics.search', {\n\t\t\ttid: tid,\n\t\t\tterm: term,\n\t\t}, function (err, pids) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (Array.isArray(pids)) {\n\t\t\t\t// Sort pids numerically & store\n\t\t\t\tSearch.current = {\n\t\t\t\t\tresults: pids.sort(function (a, b) {\n\t\t\t\t\t\treturn a - b;\n\t\t\t\t\t}),\n\t\t\t\t\ttid: tid,\n\t\t\t\t\tterm: term,\n\t\t\t\t};\n\n\t\t\t\tSearch.checkPagePresence(tid, function () {\n\t\t\t\t\tSearch.topicDOM.update(0);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n\n\tSearch.checkPagePresence = function (tid, callback) {\n\t\tif (parseInt(ajaxify.data.tid, 10) !== parseInt(tid, 10)) {\n\t\t\tajaxify.go('topic/' + tid, callback);\n\t\t} else {\n\t\t\tcallback();\n\t\t}\n\t};\n\n\tSearch.topicDOM = {\n\t\tactive: false,\n\t};\n\n\tSearch.topicDOM.prev = function () {\n\t\tSearch.topicDOM.update((Search.current.index === 0) ? Search.current.results.length - 1 : Search.current.index - 1);\n\t};\n\n\tSearch.topicDOM.next = function () {\n\t\tSearch.topicDOM.update((Search.current.index === Search.current.results.length - 1) ? 0 : Search.current.index + 1);\n\t};\n\n\tSearch.topicDOM.update = function (index) {\n\t\tvar topicSearchEl = $('.topic-search');\n\t\tSearch.current.index = index;\n\n\t\tSearch.topicDOM.start();\n\n\t\tif (Search.current.results.length > 0) {\n\t\t\ttopicSearchEl.find('.count').html((index + 1) + ' / ' + Search.current.results.length);\n\t\t\ttopicSearchEl.find('.prev, .next').removeAttr('disabled');\n\t\t\tvar data = {\n\t\t\t\tpid: Search.current.results[index],\n\t\t\t\ttid: Search.current.tid,\n\t\t\t\ttopicPostSort: config.topicPostSort,\n\t\t\t};\n\t\t\tsocket.emit('posts.getPidIndex', data, function (err, postIndex) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tnav.scrollToPost(postIndex, true);\n\t\t\t});\n\t\t} else {\n\t\t\ttranslator.translate('[[search:no-matches]]', function (text) {\n\t\t\t\ttopicSearchEl.find('.count').html(text);\n\t\t\t});\n\t\t\ttopicSearchEl.removeClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\n\t\t}\n\t};\n\n\tSearch.topicDOM.start = function () {\n\t\t$('.topic-search').removeClass('hidden');\n\t\tif (!Search.topicDOM.active) {\n\t\t\tSearch.topicDOM.active = true;\n\n\t\t\t// Bind to esc\n\t\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\t\tmousetrap.bind('esc', Search.topicDOM.end);\n\t\t\t});\n\t\t}\n\t};\n\n\tSearch.topicDOM.end = function () {\n\t\t$('.topic-search').addClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\n\t\tSearch.topicDOM.active = false;\n\n\t\t// Unbind esc\n\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\tmousetrap.unbind('esc', Search.topicDOM.end);\n\t\t});\n\t};\n\n\treturn Search;\n});\n"]}