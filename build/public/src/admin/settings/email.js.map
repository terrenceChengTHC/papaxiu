{"version":3,"sources":["public/src/admin/settings/email.js"],"names":["define","ace","module","emailEditor","init","configureEmailTester","configureEmailEditor","handleDigestHourChange","$","window","on","socket","emit","off","template","val","err","app","alertError","message","alertSuccess","updateEmailEditor","edit","$blockScrolling","Infinity","setTheme","getSession","setMode","emailPath","original","ajaxify","data","emails","forEach","email","path","newEmail","getValue","setValue","text","attr","hour","parseInt","isNaN","now","Date","toString","setHours","getTime","setDate","getDate"],"mappings":"AAAA,aAGAA,OAAO,wBAAyB,UAAW,kBAAmB,SAAUC,GACvE,IAAIC,KACJ,IAAIC,EAEJD,EAAOE,KAAO,WACbC,IACAC,IACAC,IAEAC,EAAEC,QAAQC,GAAG,yDAA0DH,GACvEC,EAAEC,QAAQC,GAAG,6BAA8B,WAC1CC,OAAOC,KAAK,6BAId,SAASP,IACRG,EAAE,oCAAoCK,IAAI,SAASH,GAAG,QAAS,WAC9DC,OAAOC,KAAK,oBAAsBE,SAAUN,EAAE,eAAeO,OAAS,SAAUC,GAC/E,GAAIA,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIG,SAE3BF,IAAIG,aAAa,qBAElB,OAAO,QAIT,SAASd,IACRE,EAAE,0BAA0BE,GAAG,SAAUW,GAEzClB,EAAcF,EAAIqB,KAAK,gBACvBnB,EAAYoB,gBAAkBC,SAC9BrB,EAAYsB,SAAS,sBACrBtB,EAAYuB,aAAaC,QAAQ,iBAEjCxB,EAAYO,GAAG,SAAU,WACxB,IAAIkB,EAAYpB,EAAE,0BAA0BO,MAC5C,IAAIc,EACJC,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAASP,EAAW,CAC7BC,EAAWK,EAAML,YAGnB,IAAIO,EAAWjC,EAAYkC,WAC3B7B,EAAE,wBAAwBO,IAAIqB,IAAaP,EAAWO,EAAW,MAGlE5B,EAAE,sCAAsCK,IAAI,SAASH,GAAG,QAAS,WAChEoB,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAAS3B,EAAE,0BAA0BO,MAAO,CACrDZ,EAAYuB,aAAaY,SAASJ,EAAML,UACxCrB,EAAE,wBAAwBO,IAAI,SAKjCM,IAGD,SAASA,IACRS,QAAQC,KAAKC,OAAOC,QAAQ,SAAUC,GACrC,GAAIA,EAAMC,OAAS3B,EAAE,0BAA0BO,MAAO,CACrDZ,EAAYuB,aAAaY,SAASJ,EAAMK,MACxC/B,EAAE,wBACAO,IAAImB,EAAMK,OAASL,EAAML,SAAWK,EAAMK,KAAO,IACjDC,KAAK,aAAc,gBAAkBN,EAAMC,SAKhD,SAAS5B,IACR,IAAIkC,EAAOC,SAASlC,EAAE,eAAeO,MAAO,IAE5C,GAAI4B,MAAMF,GAAO,CAChBA,EAAO,QACD,GAAIA,EAAO,IAAMA,EAAO,EAAG,CACjCA,EAAO,EAGR9B,OAAOC,KAAK,wBAA0B,SAAUI,EAAK4B,GACpD,GAAI5B,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIG,SAG3ByB,EAAM,IAAIC,KAAKD,GAEfpC,EAAE,eAAe+B,KAAKK,EAAIE,YAE1BF,EAAIG,SAASL,SAASD,EAAM,IAAK,EAAG,EAAG,GAGvC,GAAIG,EAAII,UAAYH,KAAKD,MAAO,CAC/BA,EAAIK,QAAQL,EAAIM,UAAY,GAG7B1C,EAAE,mBAAmB+B,KAAKK,EAAIE,cAIhC,OAAO5C","file":"public/src/admin/settings/email.js","sourcesContent":["'use strict';\n\n\ndefine('admin/settings/email', ['ace/ace', 'admin/settings'], function (ace) {\n\tvar module = {};\n\tvar emailEditor;\n\n\tmodule.init = function () {\n\t\tconfigureEmailTester();\n\t\tconfigureEmailEditor();\n\t\thandleDigestHourChange();\n\n\t\t$(window).on('action:admin.settingsLoaded action:admin.settingsSaved', handleDigestHourChange);\n\t\t$(window).on('action:admin.settingsSaved', function () {\n\t\t\tsocket.emit('admin.user.restartJobs');\n\t\t});\n\t};\n\n\tfunction configureEmailTester() {\n\t\t$('button[data-action=\"email.test\"]').off('click').on('click', function () {\n\t\t\tsocket.emit('admin.email.test', { template: $('#test-email').val() }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('Test Email Sent');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tfunction configureEmailEditor() {\n\t\t$('#email-editor-selector').on('change', updateEmailEditor);\n\n\t\temailEditor = ace.edit('email-editor');\n\t\temailEditor.$blockScrolling = Infinity;\n\t\temailEditor.setTheme('ace/theme/twilight');\n\t\temailEditor.getSession().setMode('ace/mode/html');\n\n\t\temailEditor.on('change', function () {\n\t\t\tvar emailPath = $('#email-editor-selector').val();\n\t\t\tvar original;\n\t\t\tajaxify.data.emails.forEach(function (email) {\n\t\t\t\tif (email.path === emailPath) {\n\t\t\t\t\toriginal = email.original;\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar newEmail = emailEditor.getValue();\n\t\t\t$('#email-editor-holder').val(newEmail !== original ? newEmail : '');\n\t\t});\n\n\t\t$('button[data-action=\"email.revert\"]').off('click').on('click', function () {\n\t\t\tajaxify.data.emails.forEach(function (email) {\n\t\t\t\tif (email.path === $('#email-editor-selector').val()) {\n\t\t\t\t\temailEditor.getSession().setValue(email.original);\n\t\t\t\t\t$('#email-editor-holder').val('');\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tupdateEmailEditor();\n\t}\n\n\tfunction updateEmailEditor() {\n\t\tajaxify.data.emails.forEach(function (email) {\n\t\t\tif (email.path === $('#email-editor-selector').val()) {\n\t\t\t\temailEditor.getSession().setValue(email.text);\n\t\t\t\t$('#email-editor-holder')\n\t\t\t\t\t.val(email.text !== email.original ? email.text : '')\n\t\t\t\t\t.attr('data-field', 'email:custom:' + email.path);\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction handleDigestHourChange() {\n\t\tvar hour = parseInt($('#digestHour').val(), 10);\n\n\t\tif (isNaN(hour)) {\n\t\t\thour = 17;\n\t\t} else if (hour > 23 || hour < 0) {\n\t\t\thour = 0;\n\t\t}\n\n\t\tsocket.emit('meta.getServerTime', {}, function (err, now) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tnow = new Date(now);\n\n\t\t\t$('#serverTime').text(now.toString());\n\n\t\t\tnow.setHours(parseInt(hour, 10), 0, 0, 0);\n\n\t\t\t// If adjusted time is in the past, move to next day\n\t\t\tif (now.getTime() < Date.now()) {\n\t\t\t\tnow.setDate(now.getDate() + 1);\n\t\t\t}\n\n\t\t\t$('#nextDigestTime').text(now.toString());\n\t\t});\n\t}\n\n\treturn module;\n});\n"]}