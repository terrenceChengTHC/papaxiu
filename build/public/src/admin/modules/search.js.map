{"version":3,"sources":["public/src/admin/modules/search.js"],"names":["define","mousetrap","search","find","dict","term","html","filter","elem","translations","toLowerCase","includes","map","params","namespace","title","escaped","utils","escapeRegexChars","results","replace","RegExp","trim","config","relative_path","join","init","socket","emit","err","app","alertError","setupACPSearch","dropdown","$","menu","input","searchEnabled","addClass","on","parents","ev","selected","attr","length","first","href","escape","val","ajaxify","go","setTimeout","removeClass","blur","preventDefault","bind","key","next","parent","prev","children","last","getBoundingClientRect","top","scrollIntoView","bottom","prevValue","value","remove","len","test","toggleClass","prepend","not","text"],"mappings":"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","file":"public/src/admin/modules/search.js","sourcesContent":["'use strict';\n\ndefine('admin/modules/search', ['mousetrap'], function (mousetrap) {\n\tvar search = {};\n\n\tfunction find(dict, term) {\n\t\tvar html = dict.filter(function (elem) {\n\t\t\treturn elem.translations.toLowerCase().includes(term);\n\t\t}).map(function (params) {\n\t\t\tvar namespace = params.namespace;\n\t\t\tvar translations = params.translations;\n\t\t\tvar title = params.title;\n\t\t\tvar escaped = utils.escapeRegexChars(term);\n\n\t\t\tvar results = translations\n\t\t\t\t// remove all lines without a match\n\t\t\t\t.replace(new RegExp('^(?:(?!' + escaped + ').)*$', 'gmi'), '')\n\t\t\t\t// remove lines that only match the title\n\t\t\t\t.replace(new RegExp('(^|\\\\n).*?' + title + '.*?(\\\\n|$)', 'g'), '')\n\t\t\t\t// get up to 25 characters of context on both sides of the match\n\t\t\t\t// and wrap the match in a `.search-match` element\n\t\t\t\t.replace(\n\t\t\t\t\tnew RegExp('^[\\\\s\\\\S]*?(.{0,25})(' + escaped + ')(.{0,25})[\\\\s\\\\S]*?$', 'gmi'),\n\t\t\t\t\t'...$1<span class=\"search-match\">$2</span>$3...<br>'\n\t\t\t\t)\n\t\t\t\t// collapse whitespace\n\t\t\t\t.replace(/(?:\\n ?)+/g, '\\n')\n\t\t\t\t.trim();\n\n\t\t\ttitle = title.replace(\n\t\t\t\tnew RegExp('(^.*?)(' + escaped + ')(.*?$)', 'gi'),\n\t\t\t\t'$1<span class=\"search-match\">$2</span>$3'\n\t\t\t);\n\n\t\t\treturn '<li role=\"presentation\" class=\"result\">' +\n\t\t\t\t'<a role= \"menuitem\" href= \"' + config.relative_path + '/' + namespace + '\" >' +\n\t\t\t\t\ttitle +\n\t\t\t\t\t'<br>' + (!results ? '' :\n\t\t\t\t\t('<small><code>' +\n\t\t\t\t\t\tresults +\n\t\t\t\t\t'</small></code>')) +\n\t\t\t\t'</a>' +\n\t\t\t'</li>';\n\t\t}).join('');\n\t\treturn html;\n\t}\n\n\tsearch.init = function () {\n\t\tsocket.emit('admin.getSearchDict', {}, function (err, dict) {\n\t\t\tif (err) {\n\t\t\t\tapp.alertError(err);\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\tsetupACPSearch(dict);\n\t\t});\n\t};\n\n\tfunction setupACPSearch(dict) {\n\t\tvar dropdown = $('#acp-search .dropdown');\n\t\tvar menu = $('#acp-search .dropdown-menu');\n\t\tvar input = $('#acp-search input');\n\n\t\tif (!config.searchEnabled) {\n\t\t\tmenu.addClass('search-disabled');\n\t\t}\n\n\t\tinput.on('keyup', function () {\n\t\t\tdropdown.addClass('open');\n\t\t});\n\n\t\t$('#acp-search').parents('form').on('submit', function (ev) {\n\t\t\tvar selected = menu.find('li.result > a.focus').attr('href');\n\t\t\tif (!selected.length) {\n\t\t\t\tselected = menu.find('li.result > a').first().attr('href');\n\t\t\t}\n\t\t\tvar href = selected || config.relative_path + '/search?in=titlesposts&term=' + escape(input.val());\n\n\t\t\tajaxify.go(href.replace(/^\\//, ''));\n\n\t\t\tsetTimeout(function () {\n\t\t\t\tdropdown.removeClass('open');\n\t\t\t\tinput.blur();\n\t\t\t}, 150);\n\n\t\t\tev.preventDefault();\n\t\t\treturn false;\n\t\t});\n\n\t\tmousetrap(input[0]).bind(['up', 'down'], function (ev, key) {\n\t\t\tvar next;\n\t\t\tif (key === 'up') {\n\t\t\t\tnext = menu.find('li.result > a.focus').removeClass('focus').parent().prev('.result').children();\n\t\t\t\tif (!next.length) {\n\t\t\t\t\tnext = menu.find('li.result > a').last();\n\t\t\t\t}\n\t\t\t\tnext.addClass('focus');\n\t\t\t\tif (menu[0].getBoundingClientRect().top > next[0].getBoundingClientRect().top) {\n\t\t\t\t\tnext[0].scrollIntoView(true);\n\t\t\t\t}\n\t\t\t} else if (key === 'down') {\n\t\t\t\tnext = menu.find('li.result > a.focus').removeClass('focus').parent().next('.result').children();\n\t\t\t\tif (!next.length) {\n\t\t\t\t\tnext = menu.find('li.result > a').first();\n\t\t\t\t}\n\t\t\t\tnext.addClass('focus');\n\t\t\t\tif (menu[0].getBoundingClientRect().bottom < next[0].getBoundingClientRect().bottom) {\n\t\t\t\t\tnext[0].scrollIntoView(false);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tev.preventDefault();\n\t\t});\n\n\t\tvar prevValue;\n\n\t\tinput.on('keyup focus', function () {\n\t\t\tvar value = input.val().toLowerCase();\n\n\t\t\tif (value === prevValue) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tprevValue = value;\n\n\t\t\tmenu.children('.result').remove();\n\n\t\t\tvar len = /\\W/.test(value) ? 3 : value.length;\n\t\t\tvar results;\n\n\t\t\tmenu.toggleClass('state-start-typing', len === 0);\n\t\t\tmenu.toggleClass('state-keep-typing', len > 0 && len < 3);\n\n\t\t\tif (len >= 3) {\n\t\t\t\tmenu.prepend(find(dict, value));\n\n\t\t\t\tresults = menu.children('.result').length;\n\n\t\t\t\tmenu.toggleClass('state-no-results', !results);\n\t\t\t\tmenu.toggleClass('state-yes-results', !!results);\n\n\t\t\t\tmenu.find('.search-forum')\n\t\t\t\t\t.not('.divider')\n\t\t\t\t\t.find('a')\n\t\t\t\t\t.attr('href', config.relative_path + '/search?in=titlesposts&term=' + escape(value))\n\t\t\t\t\t.find('strong')\n\t\t\t\t\t.text(value);\n\t\t\t} else {\n\t\t\t\tmenu.removeClass('state-no-results state-yes-results');\n\t\t\t}\n\t\t});\n\t}\n\n\treturn search;\n});\n"]}