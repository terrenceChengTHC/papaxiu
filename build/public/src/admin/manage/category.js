"use strict";define("admin/manage/category",["uploader","iconSelect","admin/modules/colorpicker","autocomplete","translator","categorySelector"],function(e,a,t,i,r,n){var o={};var c={};o.init=function(){$("#category-settings select").each(function(){var e=$(this);e.val(e.attr("data-value"))});$("#category-selector").on("change",function(){ajaxify.go("admin/manage/categories/"+$(this).val()+window.location.hash)});function i(e,a){var i=$(a);var r=i.parents("[data-cid]").find(".category-preview");t.enable(i,function(e,a){if(i.attr("data-name")==="bgColor"){r.css("background-color","#"+a)}else if(i.attr("data-name")==="color"){r.css("color","#"+a)}s(i[0])})}$("#category-settings input, #category-settings select").not($(".privilege-table-container input")).on("change",function(e){s(e.target)}).on("keydown",function(e){if(e.which===13){e.preventDefault();return false}});$('[data-name="imageClass"]').on("change",function(){$(".category-preview").css("background-size",$(this).val())});$('[data-name="bgColor"], [data-name="color"]').each(i);$("#save").on("click",function(){if(Object.keys(c).length){socket.emit("admin.categories.update",c,function(e,a){if(e){return app.alertError(e.message)}if(a&&a.length){app.flags._unsaved=false;app.alert({title:"Updated Categories",message:"Category IDs "+a.join(", ")+" was successfully updated.",type:"success",timeout:2e3})}});c={}}return false});$(".purge").on("click",function(e){e.preventDefault();bootbox.confirm(r.compile("admin/manage/categories:alert.confirm-purge",$("form.category").find('input[data-name="name"]').val()),function(e){if(!e){return}socket.emit("admin.categories.purge",ajaxify.data.category.cid,function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/categories:alert.purge-success]]");ajaxify.go("admin/manage/categories")})})});$(".copy-settings").on("click",function(){g(function(e){socket.emit("admin.categories.copySettingsFrom",{fromCid:e,toCid:ajaxify.data.category.cid},function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/categories:alert.copy-success]]");ajaxify.refresh()})});return false});$(".upload-button").on("click",function(){var a=$(this);var t=a.attr("data-cid");e.show({title:"[[admin/manage/categories:alert.upload-image]]",route:config.relative_path+"/api/admin/category/uploadpicture",params:{cid:t}},function(e){$("#category-image").val(e);var t=a.parent().parent().siblings(".category-preview");t.css("background","url("+e+"?"+(new Date).getTime()+")");s($("#category-image"))})});$("#category-image").on("change",function(){$(".category-preview").css("background-image",$(this).val()?'url("'+$(this).val()+'")':"")});$(".delete-image").on("click",function(e){e.preventDefault();var a=$("#category-image");var t=$(".category-preview");a.val("");t.css("background-image","");s(a[0]);$(this).parent().addClass("hide").hide()});$(".category-preview").on("click",function(){a.init($(this).find("i"),s)});$('[type="checkbox"]').on("change",function(){s($(this))});$('button[data-action="setParent"], button[data-action="changeParent"]').on("click",o.launchParentSelector);$('button[data-action="removeParent"]').on("click",function(){var e={};e[ajaxify.data.category.cid]={parentCid:0};socket.emit("admin.categories.update",e,function(e){if(e){return app.alertError(e.message)}$('button[data-action="removeParent"]').parent().addClass("hide");$('button[data-action="changeParent"]').parent().addClass("hide");$('button[data-action="setParent"]').removeClass("hide")})});o.setupPrivilegeTable();l()};function s(e){var a=ajaxify.data.category.cid;if(a){var t;if($(e).is(":checkbox")){t=$(e).is(":checked")?1:0}else{t=$(e).val()}c[a]=c[a]||{};c[a][$(e).attr("data-name")]=t;app.flags=app.flags||{};app.flags._unsaved=true}}function l(){var e=$("#tag-whitelist");e.tagsinput({confirmKeys:[13,44],trimValue:true});ajaxify.data.category.tagWhitelist.forEach(function(a){e.tagsinput("add",a)});e.on("itemAdded itemRemoved",function(){s(e)})}o.setupPrivilegeTable=function(){$(".privilege-table-container").on("change",'input[type="checkbox"]',function(){var e=$(this);var a=e.parent().attr("data-privilege");var t=e.prop("checked");var i=e.parents("tr");var r=i.attr("data-group-name")||i.attr("data-uid");var n=parseInt(i.attr("data-private")||0,10);var c=i.attr("data-group-name")!==undefined;if(r){if(c&&a==="groups:moderate"&&!n&&t){bootbox.confirm("[[admin/manage/categories:alert.confirm-moderate]]",function(i){if(i){o.setPrivilege(r,a,t,e)}else{e.prop("checked",!e.prop("checked"))}})}else{o.setPrivilege(r,a,t,e)}}else{app.alertError("[[error:invalid-data]]")}});$(".privilege-table-container").on("click",'[data-action="search.user"]',o.addUserToPrivilegeTable);$(".privilege-table-container").on("click",'[data-action="search.group"]',o.addGroupToPrivilegeTable);$(".privilege-table-container").on("click",'[data-action="copyToChildren"]',o.copyPrivilegesToChildren);$(".privilege-table-container").on("click",'[data-action="copyPrivilegesFrom"]',o.copyPrivilegesFromCategory);o.exposeAssumedPrivileges()};o.refreshPrivilegeTable=function(){socket.emit("admin.categories.getPrivilegeSettings",ajaxify.data.category.cid,function(e,a){if(e){return app.alertError(e.message)}templates.parse("admin/partials/categories/privileges",{privileges:a},function(e){r.translate(e,function(e){$(".privilege-table-container").html(e);o.exposeAssumedPrivileges()})})})};o.exposeAssumedPrivileges=function(){var e=[];$('.privilege-table tr[data-group-name="registered-users"] td input[type="checkbox"]').parent().each(function(a,t){if($(t).find("input").prop("checked")){e.push(t.getAttribute("data-privilege"))}});for(var a=0,t=e.length;a<t;a+=1){var i=$('.privilege-table tr[data-group-name]:not([data-group-name="registered-users"],[data-group-name="guests"]) td[data-privilege="'+e[a]+'"] input');i.each(function(e,a){if(!a.checked){a.indeterminate=true}})}};o.setPrivilege=function(e,a,t,i){socket.emit("admin.categories.setPrivilege",{cid:ajaxify.data.category.cid,privilege:a,set:t,member:e},function(e){if(e){return app.alertError(e.message)}i.replaceWith('<i class="fa fa-spin fa-spinner"></i>');o.refreshPrivilegeTable()})};o.launchParentSelector=function(){var e=ajaxify.data.allCategories.filter(function(e){return e&&!e.disabled&&parseInt(e.cid,10)!==parseInt(ajaxify.data.category.cid,10)});g(e,function(e){var a={};a[ajaxify.data.category.cid]={parentCid:e};socket.emit("admin.categories.update",a,function(a){if(a){return app.alertError(a.message)}var t=ajaxify.data.allCategories.filter(function(a){return a&&parseInt(a.cid,10)===parseInt(e,10)});t=t[0];$('button[data-action="removeParent"]').parent().removeClass("hide");$('button[data-action="setParent"]').addClass("hide");var i='<i class="fa '+t.icon+'"></i> '+t.name;$('button[data-action="changeParent"]').html(i).parent().removeClass("hide")})})};o.addUserToPrivilegeTable=function(){var e=bootbox.dialog({title:"[[admin/manage/categories:alert.find-user]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.user-search]]" />',show:true});e.on("shown.bs.modal",function(){var a=e.find("input");i.user(a,function(a,t){socket.emit("admin.categories.setPrivilege",{cid:ajaxify.data.category.cid,privilege:["find","read","topics:read"],set:true,member:t.item.user.uid},function(a){if(a){return app.alertError(a.message)}o.refreshPrivilegeTable();e.modal("hide")})})})};o.addGroupToPrivilegeTable=function(){var e=bootbox.dialog({title:"[[admin/manage/categories:alert.find-group]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.group-search]]" />',show:true});e.on("shown.bs.modal",function(){var a=e.find("input");i.group(a,function(a,t){socket.emit("admin.categories.setPrivilege",{cid:ajaxify.data.category.cid,privilege:["groups:find","groups:read","groups:topics:read"],set:true,member:t.item.group.name},function(a){if(a){return app.alertError(a.message)}o.refreshPrivilegeTable();e.modal("hide")})})})};o.copyPrivilegesToChildren=function(){socket.emit("admin.categories.copyPrivilegesToChildren",ajaxify.data.category.cid,function(e){if(e){return app.alertError(e.message)}app.alertSuccess("Privileges copied!")})};o.copyPrivilegesFromCategory=function(){g(function(e){socket.emit("admin.categories.copyPrivilegesFrom",{toCid:ajaxify.data.category.cid,fromCid:e},function(e){if(e){return app.alertError(e.message)}ajaxify.refresh()})})};function g(e,a){if(typeof e==="function"){a=e;e=ajaxify.data.allCategories}templates.parse("admin/partials/categories/select-category",{categories:e},function(e){r.translate(e,function(e){var t=bootbox.dialog({title:"[[modules:composer.select_category]]",message:e,buttons:{save:{label:"[[global:select]]",className:"btn-primary",callback:i}}});n.init(t.find('[component="category-selector"]'));function i(e){e.preventDefault();var i=n.getSelectedCategory();if(i){a(i.cid);t.modal("hide")}return false}t.find("form").on("submit",i)})})}return o});
//# sourceMappingURL=public/src/admin/manage/category.js.map