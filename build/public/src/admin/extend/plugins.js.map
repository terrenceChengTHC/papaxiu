{"version":3,"sources":["public/src/admin/extend/plugins.js"],"names":["define","jqueryui","translator","Plugins","init","pluginsList","$","numPlugins","querySelectorAll","length","pluginID","translate","html","append","val","on","pluginEl","this","parents","attr","btn","socket","emit","err","status","app","alertError","active","buttonText","toggleClass","prepend","clone","alert","alert_id","title","message","type","timeout","clickfn","require","instance","restart","toggleInstall","suggest","payload","bootbox","confirm","compile","responseText","removeAttr","version","confirmInstall","parent","semver","gt","find","text","upgrade","config","term","each","pluginId","indexOf","modal","activePlugins","forEach","plugin","sortable","plugins","children","data","index","el","push","name","order","populateUpgradeablePlugins","populateActivePlugins","callback","id","isActive","remove","reload","pluginData","ajaxify","refresh","installed","apply","arguments","nbbVersion","match","ajax","registry","package","dataType","done","undefined","fail","hasClass"],"mappings":"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","file":"public/src/admin/extend/plugins.js","sourcesContent":["'use strict';\n\n\ndefine('admin/extend/plugins', ['jqueryui', 'translator'], function (jqueryui, translator) {\n\tvar Plugins = {};\n\tPlugins.init = function () {\n\t\tvar pluginsList = $('.plugins');\n\t\tvar numPlugins = pluginsList[0].querySelectorAll('li').length;\n\t\tvar pluginID;\n\n\t\tif (!numPlugins) {\n\t\t\ttranslator.translate('<li><p><i>[[admin/extend/plugins:none-found]]</i></p></li>', function (html) {\n\t\t\t\tpluginsList.append(html);\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\t$('#plugin-search').val('');\n\n\t\tpluginsList.on('click', 'button[data-action=\"toggleActive\"]', function () {\n\t\t\tvar pluginEl = $(this).parents('li');\n\t\t\tpluginID = pluginEl.attr('data-plugin-id');\n\t\t\tvar btn = $('#' + pluginID + ' [data-action=\"toggleActive\"]');\n\t\t\tsocket.emit('admin.plugins.toggleActive', pluginID, function (err, status) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\ttranslator.translate('<i class=\"fa fa-power-off\"></i> [[admin/extend/plugins:plugin-item.' + (status.active ? 'deactivate' : 'activate') + ']]', function (buttonText) {\n\t\t\t\t\tbtn.html(buttonText);\n\t\t\t\t\tbtn.toggleClass('btn-warning', status.active).toggleClass('btn-success', !status.active);\n\n\t\t\t\t\t// clone it to active plugins tab\n\t\t\t\t\tif (status.active && !$('#active #' + pluginID).length) {\n\t\t\t\t\t\t$('#active ul').prepend(pluginEl.clone(true));\n\t\t\t\t\t}\n\n\t\t\t\t\tapp.alert({\n\t\t\t\t\t\talert_id: 'plugin_toggled',\n\t\t\t\t\t\ttitle: '[[admin/extend/plugins:alert.' + (status.active ? 'enabled' : 'disabled') + ']]',\n\t\t\t\t\t\tmessage: '[[admin/extend/plugins:alert.' + (status.active ? 'activate-success' : 'deactivate-success') + ']]',\n\t\t\t\t\t\ttype: status.active ? 'warning' : 'success',\n\t\t\t\t\t\ttimeout: 5000,\n\t\t\t\t\t\tclickfn: function () {\n\t\t\t\t\t\t\trequire(['admin/modules/instance'], function (instance) {\n\t\t\t\t\t\t\t\tinstance.restart();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tpluginsList.on('click', 'button[data-action=\"toggleInstall\"]', function () {\n\t\t\tvar btn = $(this);\n\t\t\tbtn.attr('disabled', true);\n\t\t\tpluginID = $(this).parents('li').attr('data-plugin-id');\n\n\t\t\tif ($(this).attr('data-installed') === '1') {\n\t\t\t\treturn Plugins.toggleInstall(pluginID, $(this).parents('li').attr('data-version'));\n\t\t\t}\n\n\t\t\tPlugins.suggest(pluginID, function (err, payload) {\n\t\t\t\tif (err) {\n\t\t\t\t\tbootbox.confirm(translator.compile('admin/extend/plugins:alert.suggest-error', err.status, err.responseText), function (confirm) {\n\t\t\t\t\t\tif (confirm) {\n\t\t\t\t\t\t\tPlugins.toggleInstall(pluginID, 'latest');\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tbtn.removeAttr('disabled');\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (payload.version !== 'latest') {\n\t\t\t\t\tPlugins.toggleInstall(pluginID, payload.version);\n\t\t\t\t} else if (payload.version === 'latest') {\n\t\t\t\t\tconfirmInstall(pluginID, function (confirm) {\n\t\t\t\t\t\tif (confirm) {\n\t\t\t\t\t\t\tPlugins.toggleInstall(pluginID, 'latest');\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tbtn.removeAttr('disabled');\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tbtn.removeAttr('disabled');\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tpluginsList.on('click', 'button[data-action=\"upgrade\"]', function () {\n\t\t\tvar btn = $(this);\n\t\t\tvar parent = btn.parents('li');\n\t\t\tpluginID = parent.attr('data-plugin-id');\n\n\t\t\tPlugins.suggest(pluginID, function (err, payload) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn bootbox.alert('[[admin/extend/plugins:alert.package-manager-unreachable]]');\n\t\t\t\t}\n\n\t\t\t\trequire(['semver'], function (semver) {\n\t\t\t\t\tif (payload.version !== 'latest' && semver.gt(payload.version, parent.find('.currentVersion').text())) {\n\t\t\t\t\t\tupgrade(pluginID, btn, payload.version);\n\t\t\t\t\t} else if (payload.version === 'latest') {\n\t\t\t\t\t\tconfirmInstall(pluginID, function () {\n\t\t\t\t\t\t\tupgrade(pluginID, btn, payload.version);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbootbox.alert(translator.compile('admin/extend/plugins:alert.incompatible', app.config.version, payload.version));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\t$('#plugin-search').on('input propertychange', function () {\n\t\t\tvar term = $(this).val();\n\t\t\t$('.plugins li').each(function () {\n\t\t\t\tvar pluginId = $(this).attr('data-plugin-id');\n\t\t\t\t$(this).toggleClass('hide', pluginId && pluginId.indexOf(term) === -1);\n\t\t\t});\n\t\t});\n\n\t\t$('#plugin-order').on('click', function () {\n\t\t\t$('#order-active-plugins-modal').modal('show');\n\t\t\tsocket.emit('admin.plugins.getActive', function (err, activePlugins) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tvar html = '';\n\t\t\t\tactivePlugins.forEach(function (plugin) {\n\t\t\t\t\thtml += '<li class=\"\">' + plugin + '</li>';\n\t\t\t\t});\n\t\t\t\tif (!activePlugins.length) {\n\t\t\t\t\ttranslator.translate('[[admin/extend/plugins:none-active]]', function (text) {\n\t\t\t\t\t\t$('#order-active-plugins-modal .plugin-list').html(text).sortable();\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t$('#order-active-plugins-modal .plugin-list').html(html).sortable();\n\t\t\t});\n\t\t});\n\n\t\t$('#save-plugin-order').on('click', function () {\n\t\t\tvar plugins = $('#order-active-plugins-modal .plugin-list').children();\n\t\t\tvar data = [];\n\t\t\tplugins.each(function (index, el) {\n\t\t\t\tdata.push({ name: $(el).text(), order: index });\n\t\t\t});\n\n\t\t\tsocket.emit('admin.plugins.orderActivePlugins', data, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\t$('#order-active-plugins-modal').modal('hide');\n\t\t\t});\n\t\t});\n\n\t\tpopulateUpgradeablePlugins();\n\t\tpopulateActivePlugins();\n\t};\n\n\tfunction confirmInstall(pluginID, callback) {\n\t\tbootbox.confirm(translator.compile('admin/extend/plugins:alert.possibly-incompatible', pluginID), function (confirm) {\n\t\t\tcallback(confirm);\n\t\t});\n\t}\n\n\tfunction upgrade(pluginID, btn, version) {\n\t\tbtn.attr('disabled', true).find('i').attr('class', 'fa fa-refresh fa-spin');\n\t\tsocket.emit('admin.plugins.upgrade', {\n\t\t\tid: pluginID,\n\t\t\tversion: version,\n\t\t}, function (err, isActive) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tvar parent = btn.parents('li');\n\t\t\tparent.find('.fa-exclamation-triangle').remove();\n\t\t\tparent.find('.currentVersion').text(version);\n\t\t\tbtn.remove();\n\t\t\tif (isActive) {\n\t\t\t\tapp.alert({\n\t\t\t\t\talert_id: 'plugin_upgraded',\n\t\t\t\t\ttitle: '[[admin/extend/plugins:alert.upgraded]]',\n\t\t\t\t\tmessage: '[[admin/extend/plugins:alert.upgrade-success]]',\n\t\t\t\t\ttype: 'warning',\n\t\t\t\t\ttimeout: 5000,\n\t\t\t\t\tclickfn: function () {\n\t\t\t\t\t\trequire(['admin/modules/instance'], function (instance) {\n\t\t\t\t\t\t\tinstance.reload();\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tPlugins.toggleInstall = function (pluginID, version, callback) {\n\t\tvar btn = $('li[data-plugin-id=\"' + pluginID + '\"] button[data-action=\"toggleInstall\"]');\n\t\tbtn.find('i').attr('class', 'fa fa-refresh fa-spin');\n\n\t\tsocket.emit('admin.plugins.toggleInstall', {\n\t\t\tid: pluginID,\n\t\t\tversion: version,\n\t\t}, function (err, pluginData) {\n\t\t\tif (err) {\n\t\t\t\tbtn.removeAttr('disabled');\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tajaxify.refresh();\n\n\t\t\tapp.alert({\n\t\t\t\talert_id: 'plugin_toggled',\n\t\t\t\ttitle: '[[admin/extend/plugins:alert.' + (pluginData.installed ? 'installed' : 'uninstalled') + ']]',\n\t\t\t\tmessage: '[[admin/extend/plugins:alert.' + (pluginData.installed ? 'install-success' : 'uninstall-success') + ']]',\n\t\t\t\ttype: 'info',\n\t\t\t\ttimeout: 5000,\n\t\t\t});\n\n\t\t\tif (typeof callback === 'function') {\n\t\t\t\tcallback.apply(this, arguments);\n\t\t\t}\n\t\t});\n\t};\n\n\tPlugins.suggest = function (pluginId, callback) {\n\t\tvar nbbVersion = app.config.version.match(/^\\d\\.\\d\\.\\d/);\n\t\t$.ajax((app.config.registry || 'https://packages.nodebb.org') + '/api/v1/suggest', {\n\t\t\ttype: 'GET',\n\t\t\tdata: {\n\t\t\t\tpackage: pluginId,\n\t\t\t\tversion: nbbVersion[0],\n\t\t\t},\n\t\t\tdataType: 'json',\n\t\t}).done(function (payload) {\n\t\t\tcallback(undefined, payload);\n\t\t}).fail(callback);\n\t};\n\n\tfunction populateUpgradeablePlugins() {\n\t\t$('#installed ul li').each(function () {\n\t\t\tif ($(this).children('[data-action=\"upgrade\"]').length) {\n\t\t\t\t$('#upgrade ul').append($(this).clone(true));\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction populateActivePlugins() {\n\t\t$('#installed ul li').each(function () {\n\t\t\tif ($(this).hasClass('active')) {\n\t\t\t\t$('#active ul').append($(this).clone(true));\n\t\t\t} else {\n\t\t\t\t$('#deactive ul').append($(this).clone(true));\n\t\t\t}\n\t\t});\n\t}\n\n\treturn Plugins;\n});\n"]}