"use strict";define("admin/extend/plugins",["jqueryui","translator"],function(e,t){var i={};i.init=function(){var e=$(".plugins");var s=e[0].querySelectorAll("li").length;var o;if(!s){t.translate("<li><p><i>[[admin/extend/plugins:none-found]]</i></p></li>",function(t){e.append(t)});return}$("#plugin-search").val("");e.on("click",'button[data-action="toggleActive"]',function(){var e=$(this).parents("li");o=e.attr("data-plugin-id");var i=$("#"+o+' [data-action="toggleActive"]');socket.emit("admin.plugins.toggleActive",o,function(n,a){if(n){return app.alertError(n)}t.translate('<i class="fa fa-power-off"></i> [[admin/extend/plugins:plugin-item.'+(a.active?"deactivate":"activate")+"]]",function(t){i.html(t);i.toggleClass("btn-warning",a.active).toggleClass("btn-success",!a.active);if(a.active&&!$("#active #"+o).length){$("#active ul").prepend(e.clone(true))}app.alert({alert_id:"plugin_toggled",title:"[[admin/extend/plugins:alert."+(a.active?"enabled":"disabled")+"]]",message:"[[admin/extend/plugins:alert."+(a.active?"activate-success":"deactivate-success")+"]]",type:a.active?"warning":"success",timeout:5e3,clickfn:function(){require(["admin/modules/instance"],function(e){e.restart()})}})})})});e.on("click",'button[data-action="toggleInstall"]',function(){var e=$(this);e.attr("disabled",true);o=$(this).parents("li").attr("data-plugin-id");if($(this).attr("data-installed")==="1"){return i.toggleInstall(o,$(this).parents("li").attr("data-version"))}i.suggest(o,function(a,l){if(a){bootbox.confirm(t.compile("admin/extend/plugins:alert.suggest-error",a.status,a.responseText),function(t){if(t){i.toggleInstall(o,"latest")}else{e.removeAttr("disabled")}});return}if(l.version!=="latest"){i.toggleInstall(o,l.version)}else if(l.version==="latest"){n(o,function(t){if(t){i.toggleInstall(o,"latest")}else{e.removeAttr("disabled")}})}else{e.removeAttr("disabled")}})});e.on("click",'button[data-action="upgrade"]',function(){var e=$(this);var l=e.parents("li");o=l.attr("data-plugin-id");i.suggest(o,function(i,r){if(i){return bootbox.alert("[[admin/extend/plugins:alert.package-manager-unreachable]]")}require(["semver"],function(i){if(r.version!=="latest"&&i.gt(r.version,l.find(".currentVersion").text())){a(o,e,r.version)}else if(r.version==="latest"){n(o,function(){a(o,e,r.version)})}else{bootbox.alert(t.compile("admin/extend/plugins:alert.incompatible",app.config.version,r.version))}})})});$("#plugin-search").on("input propertychange",function(){var e=$(this).val();$(".plugins li").each(function(){var t=$(this).attr("data-plugin-id");$(this).toggleClass("hide",t&&t.indexOf(e)===-1)})});$("#plugin-order").on("click",function(){$("#order-active-plugins-modal").modal("show");socket.emit("admin.plugins.getActive",function(e,i){if(e){return app.alertError(e)}var n="";i.forEach(function(e){n+='<li class="">'+e+"</li>"});if(!i.length){t.translate("[[admin/extend/plugins:none-active]]",function(e){$("#order-active-plugins-modal .plugin-list").html(e).sortable()});return}$("#order-active-plugins-modal .plugin-list").html(n).sortable()})});$("#save-plugin-order").on("click",function(){var e=$("#order-active-plugins-modal .plugin-list").children();var t=[];e.each(function(e,i){t.push({name:$(i).text(),order:e})});socket.emit("admin.plugins.orderActivePlugins",t,function(e){if(e){return app.alertError(e.message)}$("#order-active-plugins-modal").modal("hide")})});l();r()};function n(e,i){bootbox.confirm(t.compile("admin/extend/plugins:alert.possibly-incompatible",e),function(e){i(e)})}function a(e,t,i){t.attr("disabled",true).find("i").attr("class","fa fa-refresh fa-spin");socket.emit("admin.plugins.upgrade",{id:e,version:i},function(e,n){if(e){return app.alertError(e.message)}var a=t.parents("li");a.find(".fa-exclamation-triangle").remove();a.find(".currentVersion").text(i);t.remove();if(n){app.alert({alert_id:"plugin_upgraded",title:"[[admin/extend/plugins:alert.upgraded]]",message:"[[admin/extend/plugins:alert.upgrade-success]]",type:"warning",timeout:5e3,clickfn:function(){require(["admin/modules/instance"],function(e){e.reload()})}})}})}i.toggleInstall=function(e,t,i){var n=$('li[data-plugin-id="'+e+'"] button[data-action="toggleInstall"]');n.find("i").attr("class","fa fa-refresh fa-spin");socket.emit("admin.plugins.toggleInstall",{id:e,version:t},function(e,t){if(e){n.removeAttr("disabled");return app.alertError(e.message)}ajaxify.refresh();app.alert({alert_id:"plugin_toggled",title:"[[admin/extend/plugins:alert."+(t.installed?"installed":"uninstalled")+"]]",message:"[[admin/extend/plugins:alert."+(t.installed?"install-success":"uninstall-success")+"]]",type:"info",timeout:5e3});if(typeof i==="function"){i.apply(this,arguments)}})};i.suggest=function(e,t){var i=app.config.version.match(/^\d\.\d\.\d/);$.ajax((app.config.registry||"https://packages.nodebb.org")+"/api/v1/suggest",{type:"GET",data:{package:e,version:i[0]},dataType:"json"}).done(function(e){t(undefined,e)}).fail(t)};function l(){$("#installed ul li").each(function(){if($(this).children('[data-action="upgrade"]').length){$("#upgrade ul").append($(this).clone(true))}})}function r(){$("#installed ul li").each(function(){if($(this).hasClass("active")){$("#active ul").append($(this).clone(true))}else{$("#deactive ul").append($(this).clone(true))}})}return i});
//# sourceMappingURL=public/src/admin/extend/plugins.js.map