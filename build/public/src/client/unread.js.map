{"version":3,"sources":["public/src/client/unread.js"],"names":["define","recent","topicSelect","infinitescroll","components","Unread","$","window","on","ev","data","ajaxify","currentPage","url","removeListeners","init","app","enterRoom","this","addClass","watchForNewPosts","trigger","topics","tids","getSelectedTids","length","socket","emit","err","alertError","message","doneRemovingTids","alertSuccess","empty","removeClass","getCategoryTids","cid","get","each","push","attr","height","children","show","loadMoreTopics","config","usePagination","direction","params","utils","loadMore","after","count","topicsPerPage","filter","selectedFilter","done","onTopicsLoaded","nextStart","hide","removeTids","i","remove"],"mappings":"AAAA,aAGAA,OAAO,gBAAiB,eAAgB,cAAe,uBAAwB,cAAe,SAAUC,EAAQC,EAAaC,EAAgBC,GAC5I,IAAIC,KAEJC,EAAEC,QAAQC,GAAG,uBAAwB,SAAUC,EAAIC,GAClD,GAAIC,QAAQC,cAAgBF,EAAKG,IAAK,CACrCZ,EAAOa,qBAITT,EAAOU,KAAO,WACbC,IAAIC,UAAU,iBAEdX,EAAE,qBAAqBE,GAAG,QAAS,WAClCF,EAAEY,MAAMC,SAAS,UAGlBlB,EAAOmB,mBAEPd,EAAEC,QAAQc,QAAQ,wBAA0BC,OAAQX,QAAQD,KAAKY,SAEjEhB,EAAE,qBAAqBE,GAAG,QAAS,WAClC,IAAIe,EAAOrB,EAAYsB,kBACvB,IAAKD,EAAKE,OAAQ,CACjB,OAEDC,OAAOC,KAAK,oBAAqBJ,EAAM,SAAUK,GAChD,GAAIA,EAAK,CACR,OAAOZ,IAAIa,WAAWD,EAAIE,SAG3BC,EAAiBR,OAInBjB,EAAE,gBAAgBE,GAAG,QAAS,WAC7BkB,OAAOC,KAAK,qBAAsB,SAAUC,GAC3C,GAAIA,EAAK,CACR,OAAOZ,IAAIa,WAAWD,EAAIE,SAG3Bd,IAAIgB,aAAa,4CAEjB1B,EAAE,0BAA0B2B,QAC5B3B,EAAE,4BAA4Ba,SAAS,UACvCb,EAAE,uBAAuB4B,YAAY,UACrC5B,EAAE,aAAaa,SAAS,cAI1Bb,EAAE,aAAaE,GAAG,QAAS,YAAa,WACvC,SAAS2B,EAAgBC,GACxB,IAAIb,KACJnB,EAAWiC,IAAI,iBAAkB,MAAOD,GAAKE,KAAK,WACjDf,EAAKgB,KAAKjC,EAAEY,MAAMsB,KAAK,eAExB,OAAOjB,EAER,IAAIa,EAAM9B,EAAEY,MAAMsB,KAAK,YACvB,IAAIjB,EAAOY,EAAgBC,GAE3BV,OAAOC,KAAK,gCAAiCS,EAAK,SAAUR,GAC3D,GAAIA,EAAK,CACR,OAAOZ,IAAIa,WAAWD,EAAIE,SAG3BC,EAAiBR,OAInBrB,EAAYa,OAEZ,GAAIT,EAAE,QAAQmC,UAAYnC,EAAEC,QAAQkC,UAAYnC,EAAE,0BAA0BoC,WAAWjB,QAAU,GAAI,CACpGnB,EAAE,kBAAkBqC,OAGrBrC,EAAE,kBAAkBE,GAAG,QAAS,WAC/BoC,MAGD,IAAKC,OAAOC,cAAe,CAC1B3C,EAAeY,KAAK6B,GAGrB,SAASA,EAAeG,GACvB,GAAIA,EAAY,IAAMzC,EAAE,0BAA0BmB,OAAQ,CACzD,OAED,IAAIuB,EAASC,MAAMD,SACnB,IAAIZ,EAAMY,EAAOZ,IACjBjC,EAAe+C,SAAS,+BACvBC,MAAO7C,EAAE,0BAA0BkC,KAAK,kBACxCY,MAAOP,OAAOQ,cACdjB,IAAKA,EACLkB,OAAQ3C,QAAQD,KAAK6C,eAAeD,QAClC,SAAU5C,EAAM8C,GAClB,GAAI9C,EAAKY,QAAUZ,EAAKY,OAAOG,OAAQ,CACtCxB,EAAOwD,eAAe,SAAU/C,EAAKY,OAAQ,KAAMkC,GACnDlD,EAAE,0BAA0BkC,KAAK,iBAAkB9B,EAAKgD,eAClD,CACNF,IACAlD,EAAE,kBAAkBqD,YAMxB,SAAS5B,EAAiBR,GACzBqC,EAAWrC,GAEXP,IAAIgB,aAAa,4CAEjB,IAAK1B,EAAE,0BAA0BoC,WAAWjB,OAAQ,CACnDnB,EAAE,uBAAuB4B,YAAY,UACrC5B,EAAE,aAAaa,SAAS,WAI1B,SAASyC,EAAWrC,GACnB,IAAK,IAAIsC,EAAI,EAAGA,EAAItC,EAAKE,OAAQoC,GAAK,EAAG,CACxCzD,EAAWiC,IAAI,iBAAkB,MAAOd,EAAKsC,IAAIC,UAKnD,OAAOzD","file":"public/src/client/unread.js","sourcesContent":["'use strict';\n\n\ndefine('forum/unread', ['forum/recent', 'topicSelect', 'forum/infinitescroll', 'components'], function (recent, topicSelect, infinitescroll, components) {\n\tvar Unread = {};\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\trecent.removeListeners();\n\t\t}\n\t});\n\n\tUnread.init = function () {\n\t\tapp.enterRoom('unread_topics');\n\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\n\t\trecent.watchForNewPosts();\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\n\t\t$('#markSelectedRead').on('click', function () {\n\t\t\tvar tids = topicSelect.getSelectedTids();\n\t\t\tif (!tids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('topics.markAsRead', tids, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tdoneRemovingTids(tids);\n\t\t\t});\n\t\t});\n\n\t\t$('#markAllRead').on('click', function () {\n\t\t\tsocket.emit('topics.markAllRead', function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tapp.alertSuccess('[[unread:topics_marked_as_read.success]]');\n\n\t\t\t\t$('[component=\"category\"]').empty();\n\t\t\t\t$('[component=\"pagination\"]').addClass('hidden');\n\t\t\t\t$('#category-no-topics').removeClass('hidden');\n\t\t\t\t$('.markread').addClass('hidden');\n\t\t\t});\n\t\t});\n\n\t\t$('.markread').on('click', '.category', function () {\n\t\t\tfunction getCategoryTids(cid) {\n\t\t\t\tvar tids = [];\n\t\t\t\tcomponents.get('category/topic', 'cid', cid).each(function () {\n\t\t\t\t\ttids.push($(this).attr('data-tid'));\n\t\t\t\t});\n\t\t\t\treturn tids;\n\t\t\t}\n\t\t\tvar cid = $(this).attr('data-cid');\n\t\t\tvar tids = getCategoryTids(cid);\n\n\t\t\tsocket.emit('topics.markCategoryTopicsRead', cid, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tdoneRemovingTids(tids);\n\t\t\t});\n\t\t});\n\n\t\ttopicSelect.init();\n\n\t\tif ($('body').height() <= $(window).height() && $('[component=\"category\"]').children().length >= 20) {\n\t\t\t$('#load-more-btn').show();\n\t\t}\n\n\t\t$('#load-more-btn').on('click', function () {\n\t\t\tloadMoreTopics();\n\t\t});\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(loadMoreTopics);\n\t\t}\n\n\t\tfunction loadMoreTopics(direction) {\n\t\t\tif (direction < 0 || !$('[component=\"category\"]').length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar params = utils.params();\n\t\t\tvar cid = params.cid;\n\t\t\tinfinitescroll.loadMore('topics.loadMoreUnreadTopics', {\n\t\t\t\tafter: $('[component=\"category\"]').attr('data-nextstart'),\n\t\t\t\tcount: config.topicsPerPage,\n\t\t\t\tcid: cid,\n\t\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\t}, function (data, done) {\n\t\t\t\tif (data.topics && data.topics.length) {\n\t\t\t\t\trecent.onTopicsLoaded('unread', data.topics, true, done);\n\t\t\t\t\t$('[component=\"category\"]').attr('data-nextstart', data.nextStart);\n\t\t\t\t} else {\n\t\t\t\t\tdone();\n\t\t\t\t\t$('#load-more-btn').hide();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tfunction doneRemovingTids(tids) {\n\t\tremoveTids(tids);\n\n\t\tapp.alertSuccess('[[unread:topics_marked_as_read.success]]');\n\n\t\tif (!$('[component=\"category\"]').children().length) {\n\t\t\t$('#category-no-topics').removeClass('hidden');\n\t\t\t$('.markread').addClass('hidden');\n\t\t}\n\t}\n\n\tfunction removeTids(tids) {\n\t\tfor (var i = 0; i < tids.length; i += 1) {\n\t\t\tcomponents.get('category/topic', 'tid', tids[i]).remove();\n\t\t}\n\t}\n\n\n\treturn Unread;\n});\n"]}