{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","createTagsInput","$","ajaxify","data","createAutoComplete","get","on","toggleClass","resizeMainWindow","addHotkeys","scrollToBottom","hasOwnProperty","focus","leave","this","parents","switchChat","attr","addSendHandlers","roomId","text","val","app","previousUrl","match","go","userslug","openChat","uid","window","history","one","addEditDeleteHandler","addRenameHandler","addScrollHandler","addCharactersLeftHandler","el","loading","off","top","scrollHeight","height","scrollTop","start","parseInt","children","first","socket","emit","err","alertError","message","parseMessage","html","currentScrollTop","previousHeight","prepend","find","timeago","addClass","element","length","messageId","inputEl","prepEdit","delete","bind","activeContact","prev","next","e","target","last","lastMid","oldName","ev","type","keyCode","newName","blur","sendEl","which","shiftKey","sendMessage","strategies","options","zIndex","listPosition","position","$el","css","_applyPlacement","trigger","textcomplete","tagEl","tagsinput","confirmKeys","trimValue","users","forEach","user","username","event","cancel","item","nouser","isOwner","owner","input","require","autocomplete","remove","chat","modal","getModal","close","roomid","self","appendChatMessage","currentPage","startsWith","roomEl","recentEl","templates","parse","rooms","lastUser","fromUser","usernames","unread","translate","translated","updateUserStatus","status","onChatMessageEdit","messagesList","margin","outerHeight","inputHeight","fromTop","offset","searchHeight","searchListHeight","setActive","removeClass"],"mappings":"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","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n], function (components, translator, mousetrap, recentChats, search, messages) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\tChats.addEventListeners();\n\t\tChats.createTagsInput($('[component=\"chat/messages\"] .users-tag-input'), ajaxify.data);\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\n\t\tcomponents.get('expanded-chat/controlsToggle').on('click', function () {\n\t\t\tcomponents.get('expanded-chat/controls').toggleClass('hide');\n\t\t});\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.resizeMainWindow();\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\tmessages.scrollToBottom($('.expanded-chat ul'));\n\n\t\tChats.initialised = true;\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\t$('[component=\"chat/recent\"]').on('click', '[component=\"chat/leave\"]', function () {\n\t\t\tChats.leave($(this).parents('[data-roomid]'));\n\t\t\treturn false;\n\t\t});\n\n\t\t$('[component=\"chat/recent\"]').on('click', '[component=\"chat/recent/room\"]', function () {\n\t\t\tChats.switchChat($(this).attr('data-roomid'));\n\t\t});\n\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\n\t\tChats.addEditDeleteHandler(components.get('chat/messages'), ajaxify.data.roomId);\n\n\t\trecentChats.init();\n\n\t\tChats.addRenameHandler(ajaxify.data.roomId, $('[component=\"chat/room/name\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addCharactersLeftHandler(components.get('chat/input'));\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt($('.chat-content').children('[data-index]').first().attr('data-index'), 10) + 1;\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (element) {\n\t\telement.on('keyup', function () {\n\t\t\t$('[component=\"chat/message/length\"]').text(element.val().length);\n\t\t});\n\t};\n\n\tChats.addEditDeleteHandler = function (element, roomId) {\n\t\telement.on('click', '[data-action=\"edit\"]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t}).on('click', '[data-action=\"delete\"]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tmessages.delete(messageId, roomId);\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-primary');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-primary');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, inputEl) {\n\t\tvar oldName = inputEl.val();\n\t\tinputEl.on('blur keypress', function (ev) {\n\t\t\tif (ev.type === 'keypress' && ev.keyCode !== 13) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar newName = inputEl.val();\n\n\t\t\tif (oldName === newName) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: newName,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\toldName = newName;\n\t\t\t\tinputEl.blur();\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tzIndex: 20000,\n\t\t\t\tlistPosition: function (position) {\n\t\t\t\t\tthis.$el.css(this._applyPlacement(position));\n\t\t\t\t\tthis.$el.css('position', 'absolute');\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tdata.element.textcomplete(data.strategies, data.options);\n\t\t}\n\t};\n\n\tChats.createTagsInput = function (tagEl, data) {\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\n\t\tif (data.users && data.users.length) {\n\t\t\tdata.users.forEach(function (user) {\n\t\t\t\ttagEl.tagsinput('add', $('<div/>').html(user.username).text());\n\t\t\t});\n\t\t}\n\n\t\ttagEl.on('beforeItemAdd', function (event) {\n\t\t\tevent.cancel = event.item === app.user.username;\n\t\t});\n\n\t\ttagEl.on('itemAdded', function (event) {\n\t\t\tif (event.item === app.user.username) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\troomId: data.roomId,\n\t\t\t\tusername: event.item,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\ttagEl.tagsinput('remove', event.item, {\n\t\t\t\t\t\tnouser: true,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\ttagEl.on('beforeItemRemove', function (event) {\n\t\t\tif (event.options && event.options.nouser) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tevent.cancel = !data.isOwner || tagEl.tagsinput('items').length < 2;\n\t\t\tif (!data.owner) {\n\t\t\t\treturn app.alertError('[[error:not-allowed]]');\n\t\t\t}\n\n\t\t\tif (tagEl.tagsinput('items').length < 2) {\n\t\t\t\treturn app.alertError('[[error:cant-remove-last-user]]');\n\t\t\t}\n\t\t});\n\n\t\ttagEl.on('itemRemoved', function (event) {\n\t\t\tif (event.options && event.options.nouser) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('modules.chats.removeUserFromRoom', {\n\t\t\t\troomId: data.roomId,\n\t\t\t\tusername: event.item,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tvar input = $('.users-tag-container').find('.bootstrap-tagsinput input');\n\n\t\trequire(['autocomplete'], function (autocomplete) {\n\t\t\tautocomplete.user(input);\n\t\t});\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats/' + roomid);\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.currentPage.startsWith('chats')) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\ttemplates.parse('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\t\trecentEl.prepend(translated);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.onChatMessageEdit();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\t$('[component=\"chat/room/name\"]').val($('<div/>').html(data.newName).text());\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar messagesList = $('.expanded-chat .chat-content');\n\n\t\tif (messagesList.length) {\n\t\t\tvar margin = $('.expanded-chat ul').outerHeight(true) - $('.expanded-chat ul').height();\n\t\t\tvar inputHeight = $('.chat-input').outerHeight(true);\n\t\t\tvar fromTop = messagesList.offset().top;\n\t\t\tvar searchHeight = $('.chat-search').height();\n\t\t\tvar searchListHeight = $('[component=\"chat/search/list\"]').outerHeight(true) - $('[component=\"chat/search/list\"]').height();\n\n\t\t\tmessagesList.height($(window).height() - (fromTop + inputHeight + (margin * 4)));\n\t\t\tcomponents.get('chat/recent').height($('.expanded-chat').height() - (searchHeight + searchListHeight));\n\t\t\t$('[component=\"chat/search/list\"]').css('max-height', (components.get('chat/recent').height() / 2) + 'px');\n\t\t}\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('.expanded-chat input').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-primary');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-primary');\n\t};\n\n\n\treturn Chats;\n});\n"]}