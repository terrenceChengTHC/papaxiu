{"version":3,"sources":["public/src/client/recent.js"],"names":["define","infinitescroll","components","Recent","newTopicCount","newPostCount","$","window","on","ev","data","ajaxify","currentPage","url","removeListeners","init","app","enterRoom","watchForNewPosts","this","addClass","config","usePagination","loadMoreTopics","trigger","topics","socket","onNewTopic","onNewPost","selectedCategory","parseInt","cid","selectedFilter","filter","updateAlertText","showAlert","post","posts","topic","mainPid","pid","emit","tid","err","isFollowed","alertError","message","removeListener","text","translateText","removeClass","fadeIn","direction","length","loadMore","after","attr","count","topicsPerPage","utils","params","set","done","onTopicsLoaded","nextStart","templateName","showSelect","callback","get","parseAndTranslate","html","remove","insertAfter","last","find","timeago","createUserTooltips","makeNumbersHumanReadable"],"mappings":"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","file":"public/src/client/recent.js","sourcesContent":["'use strict';\n\n\ndefine('forum/recent', ['forum/infinitescroll', 'components'], function (infinitescroll, components) {\n\tvar\tRecent = {};\n\n\tvar newTopicCount = 0;\n\tvar newPostCount = 0;\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\tRecent.removeListeners();\n\t\t}\n\t});\n\n\tRecent.init = function () {\n\t\tapp.enterRoom('recent_topics');\n\n\t\tRecent.watchForNewPosts();\n\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(Recent.loadMoreTopics);\n\t\t}\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\t};\n\n\tRecent.watchForNewPosts = function () {\n\t\tnewPostCount = 0;\n\t\tnewTopicCount = 0;\n\t\tRecent.removeListeners();\n\t\tsocket.on('event:new_topic', onNewTopic);\n\t\tsocket.on('event:new_post', onNewPost);\n\t};\n\n\tfunction onNewTopic(data) {\n\t\tif (ajaxify.data.selectedCategory && parseInt(ajaxify.data.selectedCategory.cid, 10) !== parseInt(data.cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\treturn;\n\t\t}\n\n\t\tnewTopicCount += 1;\n\t\tRecent.updateAlertText();\n\t}\n\n\tfunction onNewPost(data) {\n\t\tfunction showAlert() {\n\t\t\tnewPostCount += 1;\n\t\t\tRecent.updateAlertText();\n\t\t}\n\n\t\tvar post = data.posts[0];\n\t\tif (!post || !post.topic) {\n\t\t\treturn;\n\t\t}\n\t\tif (parseInt(post.topic.mainPid, 10) === parseInt(post.pid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedCategory && parseInt(ajaxify.data.selectedCategory.cid, 10) !== parseInt(post.topic.cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\tsocket.emit('topics.isFollowed', post.tid, function (err, isFollowed) {\n\t\t\t\tif (err) {\n\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (isFollowed) {\n\t\t\t\t\tshowAlert();\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tshowAlert();\n\t}\n\n\tRecent.removeListeners = function () {\n\t\tsocket.removeListener('event:new_topic', onNewTopic);\n\t\tsocket.removeListener('event:new_post', onNewPost);\n\t};\n\n\tRecent.updateAlertText = function () {\n\t\tvar text = '';\n\n\t\tif (newTopicCount === 0) {\n\t\t\tif (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount === 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic]]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount > 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-are-new-topics, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-a-new-post, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-new-posts, ' + newTopicCount + ', ' + newPostCount + ']]';\n\t\t\t}\n\t\t}\n\n\t\ttext += ' [[recent:click-here-to-reload]]';\n\n\t\t$('#new-topics-alert').translateText(text).removeClass('hide').fadeIn('slow');\n\t\t$('#category-no-topics').addClass('hide');\n\t};\n\n\tRecent.loadMoreTopics = function (direction) {\n\t\tif (direction < 0 || !$('[component=\"category\"]').length) {\n\t\t\treturn;\n\t\t}\n\n\t\tinfinitescroll.loadMore('topics.loadMoreRecentTopics', {\n\t\t\tafter: $('[component=\"category\"]').attr('data-nextstart'),\n\t\t\tcount: config.topicsPerPage,\n\t\t\tcid: utils.params().cid,\n\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\tset: $('[component=\"category\"]').attr('data-set') ? $('[component=\"category\"]').attr('data-set') : 'topics:recent',\n\t\t}, function (data, done) {\n\t\t\tif (data.topics && data.topics.length) {\n\t\t\t\tRecent.onTopicsLoaded('recent', data.topics, false, done);\n\t\t\t} else {\n\t\t\t\tdone();\n\t\t\t}\n\t\t\t$('[component=\"category\"]').attr('data-nextstart', data.nextStart);\n\t\t});\n\t};\n\n\tRecent.onTopicsLoaded = function (templateName, topics, showSelect, callback) {\n\t\ttopics = topics.filter(function (topic) {\n\t\t\treturn !components.get('category/topic', 'tid', topic.tid).length;\n\t\t});\n\n\t\tif (!topics.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tapp.parseAndTranslate(templateName, 'topics', { topics: topics, showSelect: showSelect }, function (html) {\n\t\t\t$('#category-no-topics').remove();\n\n\t\t\thtml.insertAfter($('[component=\"category/topic\"]').last());\n\t\t\thtml.find('.timeago').timeago();\n\t\t\tapp.createUserTooltips();\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\n\t\t\t$(window).trigger('action:topics.loaded', { topics: topics });\n\t\t\tcallback();\n\t\t});\n\t};\n\n\treturn Recent;\n});\n"]}