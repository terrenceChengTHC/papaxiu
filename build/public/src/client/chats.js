"use strict";define("forum/chats",["components","translator","mousetrap","forum/chats/recent","forum/chats/search","forum/chats/messages"],function(t,e,a,n,o,r){var i={initialised:false};var s=false;i.init=function(){var e=utils.findBootstrapEnvironment();if(!i.initialised){i.addSocketListeners();i.addGlobalEventListeners()}i.addEventListeners();i.createTagsInput($('[component="chat/messages"] .users-tag-input'),ajaxify.data);i.createAutoComplete($('[component="chat/input"]'));t.get("expanded-chat/controlsToggle").on("click",function(){t.get("expanded-chat/controls").toggleClass("hide")});if(e==="md"||e==="lg"){i.resizeMainWindow();i.addHotkeys()}r.scrollToBottom($(".expanded-chat ul"));i.initialised=true;o.init();if(ajaxify.data.hasOwnProperty("roomId")){t.get("chat/input").focus()}};i.addEventListeners=function(){$('[component="chat/recent"]').on("click",'[component="chat/leave"]',function(){i.leave($(this).parents("[data-roomid]"));return false});$('[component="chat/recent"]').on("click",'[component="chat/recent/room"]',function(){i.switchChat($(this).attr("data-roomid"))});i.addSendHandlers(ajaxify.data.roomId,$(".chat-input"),$('.expanded-chat button[data-action="send"]'));$('[data-action="pop-out"]').on("click",function(){var e=t.get("chat/input").val();var a=ajaxify.data.roomId;if(app.previousUrl&&app.previousUrl.match(/chats/)){ajaxify.go("user/"+ajaxify.data.userslug+"/chats",function(){app.openChat(a,ajaxify.data.uid)},true)}else{window.history.go(-1);app.openChat(a,ajaxify.data.uid)}$(window).one("action:chat.loaded",function(){t.get("chat/input").val(e)})});i.addEditDeleteHandler(t.get("chat/messages"),ajaxify.data.roomId);n.init();i.addRenameHandler(ajaxify.data.roomId,$('[component="chat/room/name"]'));i.addScrollHandler(ajaxify.data.roomId,ajaxify.data.uid,$(".chat-content"));i.addCharactersLeftHandler(t.get("chat/input"))};i.addScrollHandler=function(t,e,a){var n=false;a.off("scroll").on("scroll",function(){if(n){return}var o=(a[0].scrollHeight-a.height())*.1;if(a.scrollTop()>=o){return}n=true;var i=parseInt($(".chat-content").children("[data-index]").first().attr("data-index"),10)+1;socket.emit("modules.chats.getMessages",{roomId:t,uid:e,start:i},function(t,e){if(t){return app.alertError(t.message)}if(!e){return}r.parseMessage(e,function(t){var e=a.scrollTop();var o=a[0].scrollHeight;t=$(t);a.prepend(t);t.find(".timeago").timeago();t.find("img:not(.not-responsive)").addClass("img-responsive");a.scrollTop(a[0].scrollHeight-o+e);n=false})})})};i.addCharactersLeftHandler=function(t){t.on("keyup",function(){$('[component="chat/message/length"]').text(t.val().length)})};i.addEditDeleteHandler=function(t,e){t.on("click",'[data-action="edit"]',function(){var t=$(this).parents("[data-mid]").attr("data-mid");var a=$('[data-roomid="'+e+'"] [component="chat/input"]');r.prepEdit(a,t,e)}).on("click",'[data-action="delete"]',function(){var t=$(this).parents("[data-mid]").attr("data-mid");r.delete(t,e)})};i.addHotkeys=function(){a.bind("ctrl+up",function(){var t=$(".chats-list .bg-primary");var e=t.prev();if(e.length){i.switchChat(e.attr("data-roomid"))}});a.bind("ctrl+down",function(){var t=$(".chats-list .bg-primary");var e=t.next();if(e.length){i.switchChat(e.attr("data-roomid"))}});a.bind("up",function(e){if(e.target===t.get("chat/input").get(0)){var a=t.get("chat/messages").find('.chat-message[data-self="1"]').last();var n=a.attr("data-mid");var o=t.get("chat/input");r.prepEdit(o,n,ajaxify.data.roomId)}})};i.addRenameHandler=function(t,e){var a=e.val();e.on("blur keypress",function(n){if(n.type==="keypress"&&n.keyCode!==13){return}var o=e.val();if(a===o){return}socket.emit("modules.chats.renameRoom",{roomId:t,newName:o},function(t){if(t){return app.alertError(t.message)}a=o;e.blur()})})};i.addSendHandlers=function(t,e,a){e.off("keypress").on("keypress",function(a){if(a.which===13&&!a.shiftKey){r.sendMessage(t,e);return false}});a.off("click").on("click",function(){r.sendMessage(t,e);e.focus();return false})};i.createAutoComplete=function(t){var e={element:t,strategies:[],options:{zIndex:2e4,listPosition:function(t){this.$el.css(this._applyPlacement(t));this.$el.css("position","absolute");return this}}};$(window).trigger("chat:autocomplete:init",e);if(e.strategies.length){e.element.textcomplete(e.strategies,e.options)}};i.createTagsInput=function(t,e){t.tagsinput({confirmKeys:[13,44],trimValue:true});if(e.users&&e.users.length){e.users.forEach(function(e){t.tagsinput("add",$("<div/>").html(e.username).text())})}t.on("beforeItemAdd",function(t){t.cancel=t.item===app.user.username});t.on("itemAdded",function(a){if(a.item===app.user.username){return}socket.emit("modules.chats.addUserToRoom",{roomId:e.roomId,username:a.item},function(e){if(e){app.alertError(e.message);t.tagsinput("remove",a.item,{nouser:true})}})});t.on("beforeItemRemove",function(a){if(a.options&&a.options.nouser){return}a.cancel=!e.isOwner||t.tagsinput("items").length<2;if(!e.owner){return app.alertError("[[error:not-allowed]]")}if(t.tagsinput("items").length<2){return app.alertError("[[error:cant-remove-last-user]]")}});t.on("itemRemoved",function(t){if(t.options&&t.options.nouser){return}socket.emit("modules.chats.removeUserFromRoom",{roomId:e.roomId,username:t.item},function(t){if(t){return app.alertError(t.message)}})});var a=$(".users-tag-container").find(".bootstrap-tagsinput input");require(["autocomplete"],function(t){t.user(a)})};i.leave=function(t){var e=t.attr("data-roomid");socket.emit("modules.chats.leave",e,function(a){if(a){return app.alertError(a.message)}if(parseInt(e,10)===parseInt(ajaxify.data.roomId,10)){ajaxify.go("user/"+ajaxify.data.userslug+"/chats")}else{t.remove()}require(["chat"],function(t){var a=t.getModal(e);if(a.length){t.close(a)}})})};i.switchChat=function(t){ajaxify.go("user/"+ajaxify.data.userslug+"/chats/"+t)};i.addGlobalEventListeners=function(){$(window).on("resize",i.resizeMainWindow);$(window).on("mousemove keypress click",function(){if(s&&ajaxify.data.roomId){socket.emit("modules.chats.markRead",ajaxify.data.roomId);s=false}})};i.addSocketListeners=function(){socket.on("event:chats.receive",function(a){if(parseInt(a.roomId,10)===parseInt(ajaxify.data.roomId,10)){s=a.self===0;a.message.self=a.self;r.appendChatMessage($(".expanded-chat .chat-content"),a.message)}else if(ajaxify.currentPage.startsWith("chats")){var n=$("[data-roomid="+a.roomId+"]");if(n.length>0){n.addClass("unread")}else{var o=t.get("chat/recent");templates.parse("partials/chats/recent_room",{rooms:{roomId:a.roomId,lastUser:a.message.fromUser,usernames:a.message.fromUser.username,unread:true}},function(t){e.translate(t,function(t){o.prepend(t)})})}}});socket.on("event:user_status_change",function(t){app.updateUserStatus($('.chats-list [data-uid="'+t.uid+'"] [component="user/status"]'),t.status)});r.onChatMessageEdit();socket.on("event:chats.roomRename",function(t){$('[component="chat/room/name"]').val($("<div/>").html(t.newName).text())})};i.resizeMainWindow=function(){var e=$(".expanded-chat .chat-content");if(e.length){var a=$(".expanded-chat ul").outerHeight(true)-$(".expanded-chat ul").height();var n=$(".chat-input").outerHeight(true);var o=e.offset().top;var r=$(".chat-search").height();var s=$('[component="chat/search/list"]').outerHeight(true)-$('[component="chat/search/list"]').height();e.height($(window).height()-(o+n+a*4));t.get("chat/recent").height($(".expanded-chat").height()-(r+s));$('[component="chat/search/list"]').css("max-height",t.get("chat/recent").height()/2+"px")}i.setActive()};i.setActive=function(){if(ajaxify.data.roomId){socket.emit("modules.chats.markRead",ajaxify.data.roomId);$(".expanded-chat input").focus()}$(".chats-list li").removeClass("bg-primary");$('.chats-list li[data-roomid="'+ajaxify.data.roomId+'"]').addClass("bg-primary")};return i});
//# sourceMappingURL=public/src/client/chats.js.map