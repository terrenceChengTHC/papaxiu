{"version":3,"sources":["public/src/client/topic/votes.js"],"names":["define","components","translator","Votes","addVoteHandler","get","on","loadDataAndCreateTooltip","el","$","this","parent","tooltip","off","e","stopPropagation","$this","pid","parents","attr","socket","emit","err","data","app","alertError","message","length","createTooltip","doCreateTooltip","title","usernames","otherCount","join","replace","translate","translated","toggleVote","button","className","method","post","currentState","find","room_id","ajaxify","tid","showVotes","cid","templates","parse","html","dialog","bootbox","show","modal"],"mappings":"AAAA,aAGAA,OAAO,qBAAsB,aAAc,cAAe,SAAUC,EAAYC,GAC/E,IAAIC,KAEJA,EAAMC,eAAiB,WACtBH,EAAWI,IAAI,SAASC,GAAG,aAAc,2CAA4CC,GACrFN,EAAWI,IAAI,SAASC,GAAG,WAAY,2CAA4C,WAClF,IAAIE,EAAKC,EAAEC,MAAMC,SACjBH,EAAGF,GAAG,mBAAoB,WACzBG,EAAE,YAAYG,QAAQ,WACtBJ,EAAGK,IAAI,sBAGRJ,EAAE,YAAYG,QAAQ,cAIxB,SAASL,EAAyBO,GACjCA,EAAEC,kBAEF,IAAIC,EAAQP,EAAEC,MACd,IAAIF,EAAKQ,EAAML,SACf,IAAIM,EAAMT,EAAGU,QAAQ,cAAcC,KAAK,YAExCV,EAAE,YAAYG,QAAQ,WACtBI,EAAMH,IAAI,aAAcN,GAExBa,OAAOC,KAAK,qBAAsBJ,GAAM,SAAUK,EAAKC,GACtD,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3B,GAAIH,EAAKI,OAAQ,CAChBC,EAAcpB,EAAIe,EAAK,IAExBP,EAAMH,IAAI,cAAcP,GAAG,aAAcC,KAE1C,OAAO,MAGR,SAASqB,EAAcpB,EAAIe,GAC1B,SAASM,EAAgBC,GACxBtB,EAAGW,KAAK,QAASW,GAAOlB,QAAQ,YAAYA,QAAQ,QAErD,IAAImB,EAAYR,EAAKQ,UACrB,IAAKA,EAAUJ,OAAQ,CACtB,OAED,GAAII,EAAUJ,OAASJ,EAAKS,WAAa,EAAG,CAC3CD,EAAYA,EAAUE,KAAK,MAAMC,QAAQ,KAAM,KAC/ChC,EAAWiC,UAAU,6BAA+BJ,EAAY,KAAOR,EAAKS,WAAa,KAAM,SAAUI,GACxGA,EAAaA,EAAWF,QAAQ,MAAO,KACvCL,EAAgBO,SAEX,CACNL,EAAYA,EAAUE,KAAK,MAC3BJ,EAAgBE,IAKlB5B,EAAMkC,WAAa,SAAUC,EAAQC,EAAWC,GAC/C,IAAIC,EAAOH,EAAOpB,QAAQ,cAC1B,IAAIwB,EAAeD,EAAKE,KAAKJ,GAAWZ,OAExCP,OAAOC,KAAKqB,EAAe,eAAiBF,GAC3CvB,IAAKwB,EAAKtB,KAAK,YACfyB,QAAS,SAAWC,QAAQtB,KAAKuB,KAC/B,SAAUxB,GACZ,GAAIA,EAAK,CACR,GAAIA,EAAII,UAAY,YAAa,CAChCvB,EAAM4C,UAAUN,EAAKtB,KAAK,iBACpB,CACNK,IAAIC,WAAWH,EAAII,aAKtB,OAAO,OAGRvB,EAAM4C,UAAY,SAAU9B,GAC3BG,OAAOC,KAAK,mBAAqBJ,IAAKA,EAAK+B,IAAKH,QAAQtB,KAAKyB,KAAO,SAAU1B,EAAKC,GAClF,GAAID,EAAK,CACR,GAAIA,EAAII,UAAY,0BAA2B,CAC9C,OAID,OAAOF,IAAIC,WAAWH,EAAII,SAG3BuB,UAAUC,MAAM,8BAA+B3B,EAAM,SAAU4B,GAC9DjD,EAAWiC,UAAUgB,EAAM,SAAUf,GACpC,IAAIgB,EAASC,QAAQD,QACpBtB,MAAO,SACPJ,QAASU,EACTG,UAAW,aACXe,KAAM,OAGPF,EAAO9C,GAAG,QAAS,WAClB8C,EAAOG,MAAM,iBAQlB,OAAOpD","file":"public/src/client/topic/votes.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/votes', ['components', 'translator'], function (components, translator) {\n\tvar Votes = {};\n\n\tVotes.addVoteHandler = function () {\n\t\tcomponents.get('topic').on('mouseenter', '[data-pid] [component=\"post/vote-count\"]', loadDataAndCreateTooltip);\n\t\tcomponents.get('topic').on('mouseout', '[data-pid] [component=\"post/vote-count\"]', function () {\n\t\t\tvar el = $(this).parent();\n\t\t\tel.on('shown.bs.tooltip', function () {\n\t\t\t\t$('.tooltip').tooltip('destroy');\n\t\t\t\tel.off('shown.bs.tooltip');\n\t\t\t});\n\n\t\t\t$('.tooltip').tooltip('destroy');\n\t\t});\n\t};\n\n\tfunction loadDataAndCreateTooltip(e) {\n\t\te.stopPropagation();\n\n\t\tvar $this = $(this);\n\t\tvar el = $this.parent();\n\t\tvar pid = el.parents('[data-pid]').attr('data-pid');\n\n\t\t$('.tooltip').tooltip('destroy');\n\t\t$this.off('mouseenter', loadDataAndCreateTooltip);\n\n\t\tsocket.emit('posts.getUpvoters', [pid], function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (data.length) {\n\t\t\t\tcreateTooltip(el, data[0]);\n\t\t\t}\n\t\t\t$this.off('mouseenter').on('mouseenter', loadDataAndCreateTooltip);\n\t\t});\n\t\treturn false;\n\t}\n\n\tfunction createTooltip(el, data) {\n\t\tfunction doCreateTooltip(title) {\n\t\t\tel.attr('title', title).tooltip('fixTitle').tooltip('show');\n\t\t}\n\t\tvar usernames = data.usernames;\n\t\tif (!usernames.length) {\n\t\t\treturn;\n\t\t}\n\t\tif (usernames.length + data.otherCount > 6) {\n\t\t\tusernames = usernames.join(', ').replace(/,/g, '|');\n\t\t\ttranslator.translate('[[topic:users_and_others, ' + usernames + ', ' + data.otherCount + ']]', function (translated) {\n\t\t\t\ttranslated = translated.replace(/\\|/g, ',');\n\t\t\t\tdoCreateTooltip(translated);\n\t\t\t});\n\t\t} else {\n\t\t\tusernames = usernames.join(', ');\n\t\t\tdoCreateTooltip(usernames);\n\t\t}\n\t}\n\n\n\tVotes.toggleVote = function (button, className, method) {\n\t\tvar post = button.parents('[data-pid]');\n\t\tvar currentState = post.find(className).length;\n\n\t\tsocket.emit(currentState ? 'posts.unvote' : method, {\n\t\t\tpid: post.attr('data-pid'),\n\t\t\troom_id: 'topic_' + ajaxify.data.tid,\n\t\t}, function (err) {\n\t\t\tif (err) {\n\t\t\t\tif (err.message === 'self-vote') {\n\t\t\t\t\tVotes.showVotes(post.attr('data-pid'));\n\t\t\t\t} else {\n\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn false;\n\t};\n\n\tVotes.showVotes = function (pid) {\n\t\tsocket.emit('posts.getVoters', { pid: pid, cid: ajaxify.data.cid }, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\tif (err.message === '[[error:no-privileges]]') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Only show error if it's an unexpected error.\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\ttemplates.parse('partials/modals/votes_modal', data, function (html) {\n\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\tvar dialog = bootbox.dialog({\n\t\t\t\t\t\ttitle: 'Voters',\n\t\t\t\t\t\tmessage: translated,\n\t\t\t\t\t\tclassName: 'vote-modal',\n\t\t\t\t\t\tshow: true,\n\t\t\t\t\t});\n\n\t\t\t\t\tdialog.on('click', function () {\n\t\t\t\t\t\tdialog.modal('hide');\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\n\treturn Votes;\n});\n"]}