"use strict";define("forum/category",["forum/infinitescroll","share","navigator","forum/category/tools","sort","components","translator","topicSelect","forum/pagination","storage"],function(t,e,o,a,i,n,r,c,s,g){var p={};$(window).on("action:ajaxify.start",function(t,e){if(e.url&&!e.url.startsWith("category/")){o.disable();l()}});function l(){socket.removeListener("event:new_topic",p.onNewTopic);a.removeListeners()}p.init=function(){var t=ajaxify.data.cid;app.enterRoom("category_"+t);e.addShareHandlers(ajaxify.data.name);socket.removeListener("event:new_topic",p.onNewTopic);socket.on("event:new_topic",p.onNewTopic);a.init(t);i.handleSort("categoryTopicSort","user.setCategorySort","category/"+ajaxify.data.slug);m();$('[component="category"]').on("click",'[component="topic/header"]',function(){var e=$(this).parents("[data-index]").attr("data-index");$('[component="category/topic"]').each(function(o,a){if($(a).offset().top-$(window).scrollTop()>0){g.setItem("category:"+t+":bookmark",$(a).attr("data-index"));g.setItem("category:"+t+":bookmark:clicked",e);return false}})});d();f(t);$(window).trigger("action:topics.loaded",{topics:ajaxify.data.topics});$(window).trigger("action:category.loaded",{cid:ajaxify.data.cid})};function d(){var t=window.location.pathname.split("/");var e=t[t.length-1];if(e&&utils.isNumber(e)){e=Math.max(0,parseInt(e,10)-1);if(e&&window.location.search.indexOf("page=")===-1){o.scrollToElement($('[component="category/topic"][data-index="'+e+'"]'),true,0)}}}function f(t){$('[component="category/watching"], [component="category/ignoring"]').on("click",function(){var e=$(this);var o=e.attr("component")==="category/watching"?"watch":"ignore";socket.emit("categories."+o,t,function(t){if(t){return app.alertError(t.message)}$('[component="category/watching/menu"]').toggleClass("hidden",o!=="watch");$('[component="category/watching/check"]').toggleClass("fa-check",o==="watch");$('[component="category/ignoring/menu"]').toggleClass("hidden",o!=="ignore");$('[component="category/ignoring/check"]').toggleClass("fa-check",o==="ignore");app.alertSuccess("[[category:"+o+".message]]")})})}p.toTop=function(){o.scrollTop(0)};p.toBottom=function(){socket.emit("categories.getTopicCount",ajaxify.data.cid,function(t,e){if(t){return app.alertError(t.message)}o.scrollBottom(e-1)})};p.navigatorCallback=function(t,e){return e};$(window).on("action:popstate",function(){if(ajaxify.data.template.category&&ajaxify.data.cid){var t=g.getItem("category:"+ajaxify.data.cid+":bookmark");var e=g.getItem("category:"+ajaxify.data.cid+":bookmark:clicked");g.removeItem("category:"+ajaxify.data.cid+":bookmark");g.removeItem("category:"+ajaxify.data.cid+":bookmark:clicked");t=Math.max(0,parseInt(t,10)||0);e=Math.max(0,parseInt(e,10)||0);if(!parseInt(t,10)){return}if(config.usePagination){var o=Math.ceil((parseInt(t,10)+1)/config.topicsPerPage);if(parseInt(o,10)!==ajaxify.data.pagination.currentPage){s.loadPage(o,function(){p.scrollToTopic(t,e,0)})}else{p.scrollToTopic(t,e,0)}}else{if(t===0){p.highlightTopic(e);return}$('[component="category"]').empty();h(Math.max(0,t-1)+1,1,function(){$(window).one("action:topics.loaded",function(){p.scrollToTopic(t,e,0)})})}}});p.highlightTopic=function(t){var e=n.get("category/topic","index",t);if(e.length&&!e.hasClass("highlight")){e.addClass("highlight");setTimeout(function(){e.removeClass("highlight")},5e3)}};p.scrollToTopic=function(t,e,a,i){if(!t){return}if(!i){i=0}var r=n.get("category/topic","index",t);if(r.length){$("html, body").animate({scrollTop:r.offset().top-i+"px"},a!==undefined?a:400,function(){p.highlightTopic(e);o.update()})}};function m(){if(!config.usePagination){o.init('[component="category/topic"]',ajaxify.data.topic_count,p.toTop,p.toBottom,p.navigatorCallback);t.init($('[component="category"]'),p.loadMoreTopics)}else{o.disable()}}p.onNewTopic=function(t){var e=ajaxify.data.cid;if(!t||parseInt(t.cid,10)!==parseInt(e,10)){return}$(window).trigger("filter:categories.new_topic",t);var o=!!$(".thread-tools").length;templates.parse("category","topics",{privileges:{editable:o},showSelect:o,topics:[t],template:{category:true}},function(t){r.translate(t,function(t){var e=$(t);var o=$('[component="category"]');var a=$('[component="category/topic"]');var i=a.length;$('[component="category"]').removeClass("hidden");$(".category-sidebar").removeClass("hidden");var n=$("#category-no-topics");if(n.length){n.remove();ajaxify.widgets.render("category",window.location.pathname.slice(1))}if(i>0){for(var r=0;r<i;r+=1){var c=$(a[r]).hasClass("pinned");if(!c){e.insertBefore(a[r]);break}if(r===i-1){e.insertAfter(a[r])}}}else{o.append(e)}e.hide().fadeIn("slow");e.find(".timeago").timeago();app.createUserTooltips();u();$(window).trigger("action:categories.new_topic.loaded")})})};function u(){socket.emit("categories.getTopicCount",ajaxify.data.cid,function(t,e){if(t){return app.alertError(t.message)}o.setCount(e)})}p.loadMoreTopics=function(t){if(!$('[component="category"]').length||!$('[component="category"]').children().length){return}var e=$('[component="category/topic"]');var o=t>0?e.last():e.first();var a=(parseInt(o.attr("data-index"),10)||0)+1;h(a,t)};function h(e,o,a){a=a||function(){};if(!utils.isNumber(e)||e===0&&n.get("category/topic","index",0).length){return a()}$(window).trigger("action:category.loading");var i=utils.params();t.loadMore("categories.loadMore",{cid:ajaxify.data.cid,after:e,direction:o,author:i.author,tag:i.tag,categoryTopicSort:config.categoryTopicSort},function(t,e){if(t.topics&&t.topics.length){p.onTopicsLoaded(t,o,e)}else{e()}$(window).trigger("action:category.loaded");a()})}p.onTopicsLoaded=function(e,o,a){if(!e||!e.topics.length){return a()}function i(t){return t.filter(function(t){return n.get("category/topic","tid",t.tid).length===0})}e.topics=i(e.topics);if(!e.topics.length){return a()}e.showSelect=e.privileges.editable;var r;var s;var g=$('[component="category/topic"]');if(o>0&&g.length){r=g.last()}else if(o<0&&g.length){s=g.first()}app.parseAndTranslate("category","topics",e,function(i){$('[component="category"]').removeClass("hidden");$(".category-sidebar").removeClass("hidden");$("#category-no-topics").remove();if(r){i.insertAfter(r)}else if(s){var n=$(document).height();var g=$(window).scrollTop();i.insertBefore(s);$(window).scrollTop(g+($(document).height()-n))}else{$('[component="category"]').append(i)}if(!c.getSelectedTids().length){t.removeExtra($('[component="category/topic"]'),o,config.topicsPerPage*3)}i.find(".timeago").timeago();app.createUserTooltips();utils.makeNumbersHumanReadable(i.find(".human-readable-number"));$(window).trigger("action:topics.loaded",{topics:e.topics});a()})};return p});
//# sourceMappingURL=public/src/client/category.js.map